<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobuzzz - The Hive</title>
    <style>
        :root { --main-yellow: #FFD700; --bg: #FFFDF0; --error: #ff4d4d; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        header { background: var(--main-yellow); padding: 15px; text-align: center; font-size: 28px; font-weight: bold; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Auth & Setup Containers */
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 500px; margin: 0 auto 20px; border: 2px solid var(--main-yellow); }
        .hidden { display: none; }
        
        #loginBtn { background: white; border: 2px solid #4285F4; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; display: block; margin: 0 auto; transition: 0.3s; }
        #loginBtn:hover { background: #f1f1f1; }

        input[type="text"], textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; margin-bottom: 10px; box-sizing: border-box; outline: none; font-family: inherit; }
        input[type="text"]:focus { border-color: var(--main-yellow); }

        .btn-action { background: var(--main-yellow); border: none; padding: 10px 25px; border-radius: 25px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-action:hover { transform: scale(1.05); background: #f0c800; }
        
        .error-msg { color: var(--error); font-size: 14px; margin-bottom: 10px; font-weight: bold; }
        #userWelcome { text-align: center; font-weight: bold; margin-bottom: 15px; color: #555; }

        /* Feed */
        #feed { max-width: 500px; margin: 0 auto; }
        .post { background: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; border-left: 8px solid var(--main-yellow); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .post-header { font-weight: bold; color: #222; margin-bottom: 8px; font-size: 15px; }
        .post-content { margin: 0; line-height: 1.5; color: #444; }
    </style>
</head>
<body>

<header>üêù Mobuzzz</header>

<div id="authSection" class="card">
    <button id="loginBtn">Log in with Google to enter the Hive</button>
</div>

<div id="usernameSetup" class="card hidden">
    <h3 style="margin-top:0;">Welcome! üçØ</h3>
    <p>Choose your unique username to start buzzzing:</p>
    <input type="text" id="usernameInput" placeholder="ex: queen_bee23">
    <div id="usernameError" class="error-msg hidden"></div>
    <button id="saveUsernameBtn" class="btn-action">Claim Username</button>
</div>

<div id="postArea" class="card hidden">
    <div id="userWelcome"></div>
    <textarea id="postInput" placeholder="What's the buzz today?"></textarea>
    <div style="text-align: right;">
        <button id="postBtn" class="btn-action">Post to Hive</button>
    </div>
</div>

<div id="feed"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

  // FIREBASE CONFIG (Arnold23's Credentials)
  const firebaseConfig = {
    apiKey: "AIzaSyD7d5ShdJ6djY3V5mDinsiCYZcUnBGTQpk",
    authDomain: "mobuzzz-ce112.firebaseapp.com",
    projectId: "mobuzzz-ce112",
    storageBucket: "mobuzzz-ce112.firebasestorage.app",
    messagingSenderId: "1033041132259",
    appId: "1:1033041132259:web:df28b71b2d641a697923d6",
    measurementId: "G-Q7MJMFRDQF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;
  let currentUsername = "";

  // AUTH OBSERVER
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('authSection').classList.add('hidden');
      
      // Check if user already has a username
      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);

      if (userSnap.exists()) {
        currentUsername = userSnap.data().username;
        showApp();
      } else {
        document.getElementById('usernameSetup').classList.remove('hidden');
      }
    }
  });

  // LOGIN BUTTON
  document.getElementById('loginBtn').onclick = () => {
    signInWithPopup(auth, provider).catch(err => alert("Login failed!"));
  };

  // SAVE UNIQUE USERNAME
  document.getElementById('saveUsernameBtn').onclick = async () => {
    const input = document.getElementById('usernameInput').value.trim().toLowerCase();
    const errorDiv = document.getElementById('usernameError');
    
    // Simple validation
    if (input.length < 3) {
        errorDiv.innerText = "Username must be at least 3 characters!";
        errorDiv.classList.remove('hidden');
        return;
    }

    // UNIQUE CHECK
    const nameRef = doc(db, "usernames", input);
    const nameSnap = await getDoc(nameRef);

    if (nameSnap.exists()) {
        errorDiv.innerText = "Buzzz! That username is already taken. ‚ùå";
        errorDiv.classList.remove('hidden');
    } else {
        try {
            // Reserve username and link to UID
            await setDoc(doc(db, "usernames", input), { uid: currentUser.uid });
            await setDoc(doc(db, "users", currentUser.uid), {
                username: input,
                photo: currentUser.photoURL
            });
            currentUsername = input;
            showApp();
        } catch (e) {
            alert("Error saving your identity.");
        }
    }
  };

  function showApp() {
    document.getElementById('usernameSetup').classList.add('hidden');
    document.getElementById('postArea').classList.remove('hidden');
    document.getElementById('userWelcome').innerText = "Logged in as @" + currentUsername;
  }

  // POST TO HIVE
  document.getElementById('postBtn').onclick = async () => {
    const text = document.getElementById('postInput').value;
    if (text.trim() === "") return;

    await addDoc(collection(db, "posts"), {
      content: text,
      timestamp: serverTimestamp(),
      user: currentUsername
    });
    document.getElementById('postInput').value = "";
  };

  // REAL-TIME FEED
  const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
  onSnapshot(q, (snapshot) => {
    const feed = document.getElementById('feed');
    feed.innerHTML = "";
    snapshot.forEach((doc) => {
      const data = doc.data();
      feed.innerHTML += `
        <div class="post">
            <div class="post-header">@${data.user}</div>
            <p class="post-content">${data.content}</p>
        </div>
      `;
    });
  });
</script>

</body>
</html>
