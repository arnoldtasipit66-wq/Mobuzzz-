<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobuzzz - Empire</title>
    <style>
        :root { --main-yellow: #FFD700; --bg: #FFFDF0; --gray: #888; --danger: #ff4757; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 70px; color: #333; }
        
        header { background: var(--main-yellow); padding: 15px; text-align: center; font-size: 22px; font-weight: bold; position: sticky; top: 0; z-index: 2000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .container { padding: 12px; max-width: 500px; margin: 0 auto; }
        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .hidden { display: none; }

        /* Post & Profile Styling */
        .post { background: white; padding: 15px; border-radius: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; }
        .profile-pic { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--main-yellow); cursor: pointer; }
        .btn-yellow { background: var(--main-yellow); border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        
        /* Messenger & Notifs */
        .notif-item, .chat-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .chat-msg { margin: 5px 0; padding: 8px 12px; border-radius: 15px; max-width: 80%; }
        .msg-me { background: var(--main-yellow); align-self: flex-end; margin-left: auto; }
        .msg-them { background: #eee; }

        /* Bottom Nav (Icon-style) */
        nav { display: flex; justify-content: space-around; background: white; padding: 10px 0; border-top: 1px solid #ddd; position: fixed; bottom: 0; width: 100%; z-index: 2000; }
        nav button { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--gray); position: relative; }
        nav button.active { color: #000; }
        .badge { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; }

        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

<header>üêù Mobuzzz</header>

<div class="container">
    <div id="authSection" class="card">
        <button class="btn-yellow" onclick="login()" style="width:100%">Enter the Hive</button>
    </div>

    <div id="homeTab" class="tab-content">
        <div id="postArea" class="card hidden">
            <textarea id="postInput" placeholder="What's the buzz?"></textarea>
            <button class="btn-yellow" id="postBtn" style="float:right">Buzz It!</button>
            <div style="clear:both"></div>
        </div>
        <div id="feed"></div>
    </div>

    <div id="messengerTab" class="tab-content hidden">
        <div class="card">
            <h3>Direct Messages üí¨</h3>
            <div id="chatList"></div>
        </div>
    </div>

    <div id="notifTab" class="tab-content hidden">
        <div class="card">
            <h3>Notifications üîî</h3>
            <div id="notifList"></div>
        </div>
    </div>

    <div id="profileTab" class="tab-content hidden">
        <div id="profileView" class="card" style="text-align:center">
            <img id="p-pic" class="profile-pic" style="width:80px; height:80px;">
            <h2 id="p-user">@username</h2>
            <p id="p-bio">Buzzzing...</p>
            <div id="profileActions" style="margin-bottom:15px;">
                <button id="followBtn" class="btn-yellow">Follow</button>
                <button id="msgBtn" class="btn-yellow" style="background:#eee">Message</button>
            </div>
            <div id="userPosts"></div>
        </div>
    </div>

    <div id="chatRoom" class="card hidden">
        <button onclick="switchTab('messenger')" style="float:left">‚¨ÖÔ∏è Back</button>
        <h3 id="chatWith" style="text-align:center">Chat</h3>
        <div id="messages" style="height:300px; overflow-y:auto; display:flex; flex-direction:column; gap:5px; padding:10px; border:1px solid #eee; margin-bottom:10px;"></div>
        <div style="display:flex; gap:5px;">
            <input type="text" id="chatInput" placeholder="Type a message...">
            <button class="btn-yellow" id="sendMsgBtn">Send</button>
        </div>
    </div>
</div>

<nav id="bottomNav" class="hidden">
    <button id="navHome" onclick="switchTab('home')" class="active">üè†</button>
    <button id="navNotif" onclick="switchTab('notif')">üîî<span id="notifBadge" class="badge hidden">0</span></button>
    <button id="navMsg" onclick="switchTab('messenger')">üí¨</button>
    <button id="navProfile" onclick="viewProfile(currentUsername)">üë§</button>
</nav>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, getDoc, setDoc, deleteDoc, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD7d5ShdJ6djY3V5mDinsiCYZcUnBGTQpk",
    authDomain: "mobuzzz-ce112.firebaseapp.com",
    projectId: "mobuzzz-ce112",
    storageBucket: "mobuzzz-ce112.firebasestorage.app",
    messagingSenderId: "1033041132259",
    appId: "1:1033041132259:web:df28b71b2d641a697923d6",
    measurementId: "G-Q7MJMFRDQF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;
  let currentUsername = "";
  let currentChatId = null;

  window.login = () => signInWithPopup(auth, provider);

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('authSection').classList.add('hidden');
      const uSnap = await getDoc(doc(db, "users", user.uid));
      if (uSnap.exists()) {
        currentUsername = uSnap.data().username;
        startApp();
      } else {
        const name = prompt("Unique Username:");
        if (name) {
          await setDoc(doc(db, "usernames", name.toLowerCase()), { uid: user.uid });
          await setDoc(doc(db, "users", user.uid), { username: name.toLowerCase(), photo: user.photoURL });
          location.reload();
        }
      }
    }
  });

  function startApp() {
    document.getElementById('bottomNav').classList.remove('hidden');
    document.getElementById('postArea').classList.remove('hidden');
    loadFeed();
    listenNotifs();
  }

  // --- NOTIFICATIONS ---
  function listenNotifs() {
    const q = query(collection(db, "users", currentUser.uid, "notifs"), orderBy("time", "desc"), limit(20));
    onSnapshot(q, s => {
      const list = document.getElementById('notifList');
      list.innerHTML = "";
      document.getElementById('notifBadge').innerText = s.size;
      document.getElementById('notifBadge').classList.toggle('hidden', s.size === 0);
      s.forEach(d => {
        list.innerHTML += `<div class="notif-item">üêù <b>@${d.data().from}</b> ${d.data().msg}</div>`;
      });
    });
  }

  async function sendNotif(targetUid, msg) {
    if (targetUid === currentUser.uid) return;
    await addDoc(collection(db, "users", targetUid, "notifs"), { from: currentUsername, msg: msg, time: serverTimestamp() });
  }

  // --- FEED & PROFILE ---
  function loadFeed() {
    const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
    onSnapshot(q, s => {
      const feed = document.getElementById('feed');
      feed.innerHTML = "";
      s.forEach(d => {
        const data = d.data();
        feed.innerHTML += `
          <div class="post">
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                <img src="${data.userPhoto}" class="profile-pic" style="width:30px; height:30px;" onclick="viewProfile('${data.user}')">
                <b onclick="viewProfile('${data.user}')">@${data.user}</b>
            </div>
            <div>${data.content}</div>
          </div>`;
      });
    });
  }

  window.viewProfile = async (username) => {
    switchTab('profile');
    const uSnap = await getDocs(query(collection(db, "users"), where("username", "==", username)));
    uSnap.forEach(async d => {
        const uData = d.data();
        document.getElementById('p-user').innerText = "@" + username;
        document.getElementById('p-pic').src = uData.photo;
        document.getElementById('profileActions').classList.toggle('hidden', username === currentUsername);
        
        document.getElementById('followBtn').onclick = () => {
            sendNotif(d.id, "started following you!");
            alert("Followed!");
        };
        document.getElementById('msgBtn').onclick = () => openChat(d.id, username);
    });
  }

  // --- MESSENGER ---
  async function openChat(targetUid, targetName) {
    switchTab('chat');
    document.getElementById('chatWith').innerText = "Chat with @" + targetName;
    currentChatId = [currentUser.uid, targetUid].sort().join("_");
    
    const q = query(collection(db, "chats", currentChatId, "messages"), orderBy("time", "asc"));
    onSnapshot(q, s => {
        const box = document.getElementById('messages');
        box.innerHTML = "";
        s.forEach(m => {
            const isMe = m.data().sender === currentUser.uid;
            box.innerHTML += `<div class="chat-msg ${isMe ? 'msg-me' : 'msg-them'}">${m.data().text}</div>`;
        });
        box.scrollTop = box.scrollHeight;
    });
  }

  document.getElementById('sendMsgBtn').onclick = async () => {
    const input = document.getElementById('chatInput');
    if (!input.value.trim() || !currentChatId) return;
    await addDoc(collection(db, "chats", currentChatId, "messages"), {
        text: input.value,
        sender: currentUser.uid,
        time: serverTimestamp()
    });
    input.value = "";
  };

  // --- TAB SYSTEM ---
  window.switchTab = (tab) => {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('chatRoom').classList.add('hidden');
    if(tab === 'home') document.getElementById('homeTab').classList.remove('hidden');
    if(tab === 'notif') document.getElementById('notifTab').classList.remove('hidden');
    if(tab === 'messenger') document.getElementById('messengerTab').classList.remove('hidden');
    if(tab === 'profile') document.getElementById('profileTab').classList.remove('hidden');
    if(tab === 'chat') document.getElementById('chatRoom').classList.remove('hidden');
  }

  // Post Logic
  document.getElementById('postBtn').onclick = async () => {
    const val = document.getElementById('postInput').value;
    if (!val.trim()) return;
    await addDoc(collection(db, "posts"), { content: val, user: currentUsername, userPhoto: currentUser.photoURL, timestamp: serverTimestamp() });
    document.getElementById('postInput').value = "";
  };
</script>
</body>
</html>
