<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mobuzzz Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFD700">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default"> 
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #FFD700; 
            --bg: #FFD700; 
            --card-bg: #ffffff; 
            --text: #212529; 
            --gray: #6c757d; 
            --blue: #0099ff; 
        }
        
        /* DEFAULT BODY (Portrait / Social Mode) */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; padding: 0; 
            /* Space para sa navigation sa baba */
            padding-bottom: calc(85px + env(safe-area-inset-bottom)); 
            overscroll-behavior-y: none; 
            -webkit-tap-highlight-color: transparent;
        }
        
        /* --- üî• GAME MODE: IMMERSIVE FULLSCREEN FIX üî• --- */
        body.game-mode { 
            background: #000 !important; 
            padding: 0 !important; /* Tanggalin ang padding para sagad */
            margin: 0 !important;
            overflow: hidden !important; 
        }

        /* HIDE UI ELEMENTS IN GAME MODE */
        body.game-mode header, 
        body.game-mode .bottom-nav, 
        body.game-mode .fab, 
        body.game-mode .container { 
            display: none !important; 
        }
        
        /* THE GAME CONTAINER */
        .game-wrapper { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100vw; height: 100vh; 
            background: #000; 
            z-index: 5000; 
            display: flex; align-items: center; justify-content: center;
        }
        
        /* THE ROTATED IFRAME (Sagad sa Screen) */
        .game-frame { 
            /* Baliktarin ang width at height para sa rotation */
            width: 100vh; 
            height: 100vw; 
            
            /* Gitna at Rotate */
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(90deg);
            
            border: none; 
            display: block;
        }
        
        /* --- END GAME MODE STYLES --- */

        /* HEADER */
        header { 
            background: var(--card-bg); padding: 15px; 
            padding-top: calc(15px + env(safe-area-inset-top));
            position: sticky; top: 0; z-index: 100; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            display: flex; justify-content: space-between; align-items: center; 
        }
        h1 { margin: 0; font-size: 22px; font-weight: 900; color: #000; letter-spacing: -1px; }
        .brand span { color: #f39c12; }
        
        .container { max-width: 600px; margin: 0 auto; padding: 10px; }
        .view-section { display: none; animation: fadeIn 0.3s ease-out; }
        .view-section.active { display: block; }

        /* POST CARDS */
        .post-card { 
            background: var(--card-bg); 
            border-radius: 16px; 
            padding: 15px; 
            margin-bottom: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            border: none;
        }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); cursor: pointer; }
        .user-meta { flex: 1; }
        .user-name { font-weight: 700; font-size: 15px; display: block; }
        .post-time { font-size: 12px; color: var(--gray); }
        .post-content { font-size: 15px; line-height: 1.5; margin-bottom: 15px; white-space: pre-wrap; }
        .post-actions { display: flex; justify-content: space-between; border-top: 1px solid #f0f0f0; padding-top: 10px; }
        .action-btn { background: none; border: none; display: flex; align-items: center; gap: 5px; color: var(--gray); font-size: 14px; cursor: pointer; padding: 5px 10px; border-radius: 20px; transition: background 0.2s; }
        .action-btn:hover { background: #f8f9fa; }
        .action-btn.liked { color: #e91e63; }
        
        /* EXIT BUTTON (Highest Z-Index) */
        .game-exit-btn { 
            position: fixed; top: 20px; right: 90px; 
            width: 45px; height: 45px; border-radius: 50%; 
            background: rgba(255, 0, 0, 0.9); color: white; border: 2px solid white; 
            z-index: 99999; /* Surebol na mapipindot */
            display: flex; align-items: center; justify-content: center; 
            transform: rotate(90deg); cursor: pointer;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* LOADING CURTAIN */
        #loadingCurtain {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 5500; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; pointer-events: none; transition: opacity 0.5s ease;
        }
        .rotate-content { transform: rotate(90deg); text-align: center; }

        /* EXIT CONFIRMATION */
        .exit-confirm-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100000; justify-content: center; align-items: center; }
        .exit-box { background: white; padding: 25px; border-radius: 20px; text-align: center; width: 300px; transform: rotate(90deg); border: 4px solid var(--primary); }
        .exit-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .btn-game-opt { padding: 10px 20px; border-radius: 20px; font-weight: bold; border: none; cursor: pointer; }

        /* CHAT UI */
        .chat-list-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .chat-container { height: calc(100vh - 160px); overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .chat-bubble { max-width: 75%; padding: 10px 15px; border-radius: 18px; font-size: 15px; line-height: 1.4; }
        .chat-bubble.me { align-self: flex-end; background: var(--blue); color: white; border-bottom-right-radius: 4px; }
        .chat-bubble.them { align-self: flex-start; background: #e4e6eb; color: black; border-bottom-left-radius: 4px; }
        .chat-input-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 10px; display: flex; gap: 10px; align-items: center; padding-bottom: calc(10px + env(safe-area-inset-bottom)); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 2002; }

        /* NOTIFICATIONS */
        .notif-item { background: white; padding: 15px; margin-bottom: 5px; border-radius: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .notif-item.unread { background: #fffde7; border-left: 5px solid #ff4444; }
        .red-dot { width: 10px; height: 10px; background: #ff4444; border-radius: 50%; position: absolute; top: 5px; right: 25%; border: 2px solid white; display: none; }
        .red-dot.visible { display: block; }

        /* NAVIGATION */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; padding-bottom: calc(10px + env(safe-area-inset-bottom)); border-top-left-radius: 20px; border-top-right-radius: 20px; z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
        .nav-item { border: none; background: none; color: var(--gray); display: flex; flex-direction: column; align-items: center; gap: 4px; width: 20%; cursor: pointer; }
        .nav-item.active { color: #000; font-weight: bold; }
        .nav-item .material-icons-round { font-size: 28px; }

        /* FAB */
        .fab { position: fixed; bottom: calc(90px + env(safe-area-inset-bottom)); right: 20px; background: black; color: var(--primary); width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 2px solid var(--primary); z-index: 900; cursor: pointer; }

        /* PROFILE */
        .profile-header { text-align: center; padding: 30px; background: white; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .profile-pic-lg { width: 90px; height: 90px; border-radius: 50%; border: 4px solid var(--primary); object-fit: cover; margin-bottom: 10px; }
        .btn-group { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .btn-profile { padding: 10px 25px; border-radius: 25px; font-weight: bold; border: none; cursor: pointer; font-size: 14px; }
        .btn-logout { background: #ff4444; color: white; }
        .btn-follow { background: black; color: white; border: 1px solid black; }
        .btn-following { background: white; color: black; border: 1px solid #ddd; }
        .btn-message { background: var(--blue); color: white; }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: flex-end; }
        .modal-content { background: white; width: 100%; max-width: 600px; border-radius: 20px 20px 0 0; padding: 20px; padding-bottom: calc(20px + env(safe-area-inset-bottom)); animation: slideUp 0.3s ease; max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
        
        .comment-list { flex: 1; overflow-y: auto; margin-bottom: 10px; max-height: 40vh; }
        .comment-item { display: flex; gap: 10px; margin-bottom: 10px; font-size: 14px; }
        .comment-item.reply { margin-left: 40px; border-left: 3px solid var(--primary); padding-left: 10px; background: #f9f9f9; padding: 10px; border-radius: 8px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<button class="game-exit-btn" id="gameExitBtn" onclick="showExitConfirm()" style="display:none;">
    <span class="material-icons-round">close</span>
</button>

<div id="exitConfirmModal" class="exit-confirm-modal">
    <div class="exit-box">
        <span class="material-icons-round" style="font-size:48px; color:#d32f2f;">warning</span>
        <h3>Exit Game?</h3>
        <div class="exit-actions">
            <button class="btn-game-opt" style="background:#eee; color:black;" onclick="closeExitConfirm()">Cancel</button>
            <button class="btn-game-opt" style="background:#ff4444; color:white;" onclick="confirmExitGame()">Exit</button>
        </div>
    </div>
</div>

<header id="mainHeader">
    <div class="brand"><h1>üêù Mobuzzz<span>Pro</span></h1></div>
    <div id="authBtnContainer"></div>
</header>

<div id="view-games" class="view-section">
    <div class="game-wrapper">
        <div id="loadingCurtain">
            <div class="rotate-content">
                <span class="material-icons-round" style="font-size:48px; display:block; margin-bottom:10px;">screen_rotation</span> 
                <h2>Loading...</h2>
                <p>Rotate Phone</p>
            </div>
        </div>
        <iframe src="https://arnoldtasipit66-wq.github.io/my-game-assets/" class="game-frame" title="Pinoy Pool"></iframe>
    </div>
</div>

<div class="container">
    <div id="view-home" class="view-section active">
        <div id="feed"><p style="text-align:center; padding:20px; color:black;">Connecting to Hive...</p></div>
    </div>

    <div id="view-messages" class="view-section">
        <h2 style="padding:0 10px; color:black;">Inbox</h2>
        <div id="inbox-list">
            <p style="text-align:center; margin-top:50px; color:#555;">No conversations yet.</p>
        </div>
    </div>

    <div id="view-notifications" class="view-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="margin:0; color:black;">Notifications</h3>
            <button onclick="markAllRead()" style="background:none; border:none; font-weight:bold; cursor:pointer;">Mark read</button>
        </div>
        <div id="notif-list"><p style="text-align:center; color:#555;">No updates.</p></div>
    </div>

    <div id="view-profile" class="view-section">
        <div id="profile-content"></div>
    </div>
</div>

<div id="view-conversation" class="view-section" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#f0f2f5; z-index:3000; display:none;">
    <div style="background:white; padding:15px; padding-top:calc(15px + env(safe-area-inset-top)); display:flex; align-items:center; gap:10px; border-bottom:1px solid #ddd;">
        <button onclick="closeChat()" style="background:none; border:none;"><span class="material-icons-round">arrow_back</span></button>
        <img id="chat-header-avatar" src="" style="width:35px; height:35px; border-radius:50%;">
        <b id="chat-header-name">User</b>
    </div>
    <div id="chat-messages" class="chat-container"></div>
    <div class="chat-input-bar">
        <input type="text" id="messageInput" placeholder="Type a message..." style="flex:1; padding:12px; border-radius:20px; border:1px solid #ddd; outline:none;">
        <button onclick="sendMessage()" style="background:var(--blue); color:white; border:none; padding:10px; border-radius:50%; display:flex;"><span class="material-icons-round">send</span></button>
    </div>
</div>

<button class="fab" id="fabPost"><span class="material-icons-round">add</span></button>

<nav class="bottom-nav" id="mainNav">
    <button class="nav-item active" onclick="switchView('home')"><span class="material-icons-round">home</span></button>
    <button class="nav-item" onclick="switchView('games')"><span class="material-icons-round">sports_esports</span></button>
    <button class="nav-item" onclick="switchView('messages')"><span class="material-icons-round">mail</span></button>
    <button class="nav-item" onclick="switchView('notifications')">
        <span class="material-icons-round">notifications</span><span id="notif-badge" class="red-dot"></span>
    </button>
    <button class="nav-item" onclick="switchView('profile')"><span class="material-icons-round">person</span></button>
</nav>

<div id="postModal" class="modal" onclick="closeModal(event, 'postModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>Create Buzz</h3>
        <textarea id="postInput" placeholder="What's on your mind?" style="width:100%; height:100px; border:1px solid #ddd; padding:10px; border-radius:10px;"></textarea>
        <div style="text-align:right; margin-top:10px;">
            <button onclick="document.getElementById('postModal').style.display='none'" style="margin-right:10px; background:none; border:none;">Cancel</button>
            <button id="submitPostBtn" style="background:black; color:var(--primary); border:none; padding:8px 20px; border-radius:20px; font-weight:bold;">Post</button>
        </div>
    </div>
</div>

<div id="commentModal" class="modal" onclick="closeModal(event, 'commentModal')">
    <div class="modal-content" style="height: 60vh;" onclick="event.stopPropagation()">
        <h3 style="margin-top:0;">Comments</h3>
        <div id="commentList" class="comment-list"></div>
        <div id="replyBanner" style="font-size:12px; color:var(--blue); display:none; padding:5px;">Replying... <span onclick="cancelReply()" style="float:right; cursor:pointer;">&times;</span></div>
        <div style="display:flex; gap:10px; margin-top:auto;">
            <input type="text" id="commentInput" placeholder="Write a comment..." style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd; outline:none;">
            <button id="sendCommentBtn" style="background:var(--primary); border:none; border-radius:50%; width:40px; height:40px; font-weight:bold;">‚û§</button>
        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, arrayUnion, arrayRemove, serverTimestamp, query, orderBy, where, onSnapshot, enableIndexedDbPersistence, increment } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD7d5ShdJ6djY3V5mDinsiCYZcUnBGTQpk",
    authDomain: "mobuzzz-ce112.firebaseapp.com",
    projectId: "mobuzzz-ce112",
    storageBucket: "mobuzzz-ce112.firebasestorage.app",
    messagingSenderId: "1033041132259",
    appId: "1:1033041132259:web:df28b71b2d641a697923d6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  try { enableIndexedDbPersistence(db).catch(e=>{}); } catch(e){}

  let currentUser = null;
  let activeChatId = null;
  let activePostId = null;
  let replyToId = null;

  // --- NAVIGATION & GAME ---
  window.switchView = (viewName) => {
    document.getElementById('view-conversation').style.display = 'none';
    document.getElementById('mainNav').style.display = 'flex';
    document.getElementById('mainHeader').style.display = 'flex';
    
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

    if(viewName === 'games') {
        document.body.classList.add('game-mode');
        document.getElementById('view-games').classList.add('active');
        document.getElementById('gameExitBtn').style.display = 'flex';
        document.querySelectorAll('.nav-item')[1].classList.add('active');

        // üî• MAGIC FIX: Force remove curtain after 3 seconds
        const curtain = document.getElementById('loadingCurtain');
        if(curtain) {
            curtain.style.display = 'flex'; curtain.style.opacity = '1';
            setTimeout(() => { 
                curtain.style.opacity = '0'; 
                setTimeout(() => curtain.style.display = 'none', 500);
            }, 3000);
        }
        return; 
    } else {
        document.body.classList.remove('game-mode'); 
        document.getElementById('gameExitBtn').style.display = 'none';
        document.getElementById('exitConfirmModal').style.display = 'none';
    }

    document.getElementById(`view-${viewName}`).classList.add('active');
    
    const idx = ['home', 'games', 'messages', 'notifications', 'profile'].indexOf(viewName);
    if(idx >= 0) document.querySelectorAll('.nav-item')[idx].classList.add('active');

    if(viewName === 'profile' && currentUser) loadProfile(currentUser.uid);
    if(viewName === 'messages' && currentUser) loadInbox();
  };

  window.showExitConfirm = () => document.getElementById('exitConfirmModal').style.display = 'flex';
  window.closeExitConfirm = () => document.getElementById('exitConfirmModal').style.display = 'none';
  window.confirmExitGame = () => { window.closeExitConfirm(); window.switchView('home'); };
  window.closeModal = (e, id) => { if(e.target.id === id) document.getElementById(id).style.display = 'none'; };

  // --- AUTH ---
  document.getElementById('fabPost').onclick = () => currentUser ? document.getElementById('postModal').style.display = 'flex' : login();
  const login = () => signInWithPopup(auth, new GoogleAuthProvider());
  window.doLogout = () => signOut(auth).then(() => window.location.reload());

  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    const container = document.getElementById('authBtnContainer');
    if (user) {
      container.innerHTML = `<img src="${user.photoURL}" style="width:32px; height:32px; border-radius:50%; border:2px solid black;" onclick="switchView('profile')">`;
      await setDoc(doc(db, "users", user.uid), { displayName: user.displayName, photoURL: user.photoURL, email: user.email }, { merge: true });
      listenToNotifications(user.uid);
    } else {
      container.innerHTML = `<button onclick="login()" style="background:black; color:var(--primary); border:none; padding:8px 15px; border-radius:15px; font-weight:bold;">Login</button>`;
      window.login = login;
    }
  });

  // --- POSTS ---
  document.getElementById('submitPostBtn').onclick = async () => {
      const text = document.getElementById('postInput').value;
      if(!text.trim()) return;
      document.getElementById('postModal').style.display = 'none';
      await addDoc(collection(db, "posts"), {
          content: text, timestamp: serverTimestamp(), uid: currentUser.uid,
          authorName: currentUser.displayName, authorPhoto: currentUser.photoURL,
          likes: [], commentsCount: 0
      });
      document.getElementById('postInput').value = "";
  };

  const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
  onSnapshot(q, (snapshot) => {
      const feed = document.getElementById('feed');
      let html = "";
      snapshot.forEach(doc => {
          const p = doc.data();
          const isLiked = p.likes && currentUser && p.likes.includes(currentUser.uid);
          html += `
            <div class="post-card" id="post-${doc.id}">
                <div class="post-header">
                    <img src="${p.authorPhoto}" class="user-avatar" onclick="viewUserProfile('${p.uid}')">
                    <div class="user-meta">
                        <b onclick="viewUserProfile('${p.uid}')">${p.authorName}</b>
                        <div class="post-time">${p.timestamp ? new Date(p.timestamp.toDate()).toLocaleTimeString() : '...'}</div>
                    </div>
                </div>
                <div class="post-content">${p.content}</div>
                <div class="post-actions">
                    <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${doc.id}', ${isLiked}, '${p.uid}')">
                        <span class="material-icons-round">${isLiked ? 'favorite' : 'favorite_border'}</span> ${p.likes ? p.likes.length : 0}
                    </button>
                    <button class="action-btn" onclick="openComments('${doc.id}', '${p.uid}')">
                        <span class="material-icons-round">chat_bubble_outline</span> ${p.commentsCount || 0}
                    </button>
                </div>
            </div>`;
      });
      feed.innerHTML = html;
  });

  window.toggleLike = async (postId, isLiked, ownerId) => {
      if(!currentUser) return login();
      const ref = doc(db, "posts", postId);
      if(isLiked) await updateDoc(ref, { likes: arrayRemove(currentUser.uid) });
      else {
          await updateDoc(ref, { likes: arrayUnion(currentUser.uid) });
          if(ownerId !== currentUser.uid) sendNotif(ownerId, 'like', postId, null);
      }
  };

  async function sendNotif(toUid, type, postId, extra) {
      await addDoc(collection(db, "notifications"), {
          toUid, fromUid: currentUser.uid, fromName: currentUser.displayName,
          type, postId, read: false, timestamp: serverTimestamp(), ...extra
      });
  }

  // --- COMMENTS & REPLY ---
  window.cancelReply = () => {
      replyToId = null;
      document.getElementById('replyBanner').style.display = 'none';
      document.getElementById('commentInput').placeholder = "Write a comment...";
  };

  window.initReply = (id, name) => {
      replyToId = id;
      document.getElementById('replyBanner').innerHTML = `Replying to <b>${name}</b> <span onclick="cancelReply()" style="float:right; cursor:pointer;">&times;</span>`;
      document.getElementById('replyBanner').style.display = 'block';
      document.getElementById('commentInput').focus();
  };

  window.openComments = (postId, postOwnerId) => {
      activePostId = postId;
      cancelReply();
      document.getElementById('commentModal').style.display = 'flex';
      
      const q = query(collection(db, `posts/${postId}/comments`), orderBy("timestamp", "asc"));
      onSnapshot(q, (snap) => {
          const list = document.getElementById('commentList');
          list.innerHTML = "";
          let comments = [];
          snap.forEach(d => comments.push({id: d.id, ...d.data()}));
          
          comments.forEach(c => {
              const isReply = c.replyToId ? 'reply' : '';
              list.innerHTML += `
              <div class="comment-item ${isReply}">
                <img src="${c.photo}" class="comment-avatar">
                <div style="width:100%">
                    <div style="background:#f0f2f5; padding:8px 12px; border-radius:15px; width:fit-content;">
                        <b>${c.user}</b><br>${c.text}
                    </div>
                    <div style="font-size:12px; margin-top:2px;">
                        <span onclick="initReply('${c.id}', '${c.user}')" style="cursor:pointer; color:#555; font-weight:bold;">Reply</span>
                    </div>
                </div>
              </div>`;
          });
      });

      const btn = document.getElementById('sendCommentBtn');
      btn.onclick = async () => {
          const txt = document.getElementById('commentInput').value;
          if(!txt.trim()) return;
          
          await addDoc(collection(db, `posts/${activePostId}/comments`), {
              text: txt, user: currentUser.displayName, photo: currentUser.photoURL,
              timestamp: serverTimestamp(), replyToId: replyToId
          });
          
          await updateDoc(doc(db, "posts", activePostId), { commentsCount: increment(1) });
          if(postOwnerId !== currentUser.uid) sendNotif(postOwnerId, 'comment', activePostId);
          
          document.getElementById('commentInput').value = "";
          cancelReply();
      };
  };

  // --- MESSAGES ---
  function getChatId(u1, u2) { return [u1, u2].sort().join("_"); }

  window.startChat = async (targetUid, name, photo) => {
      if(!currentUser) return login();
      const chatId = getChatId(currentUser.uid, targetUid);
      
      // CREATE CHAT METADATA IF NOT EXISTS
      await setDoc(doc(db, "chats", chatId), {
          participants: [currentUser.uid, targetUid],
          users: {
              [currentUser.uid]: { name: currentUser.displayName, photo: currentUser.photoURL },
              [targetUid]: { name: name, photo: photo }
          },
          lastUpdated: serverTimestamp()
      }, { merge: true });

      openChatWindow(chatId, name, photo);
  };

  window.loadInbox = () => {
      const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid), orderBy("lastUpdated", "desc"));
      onSnapshot(q, (snap) => {
          const list = document.getElementById('inbox-list');
          if(snap.empty) { list.innerHTML = '<p style="text-align:center;margin-top:20px;color:#555">No messages yet.</p>'; return; }
          
          let html = "";
          snap.forEach(d => {
              const data = d.data();
              const otherUid = data.participants.find(id => id !== currentUser.uid);
              const otherUser = data.users[otherUid];
              
              html += `
              <div class="chat-list-item" onclick="openChatWindow('${d.id}', '${otherUser.name}', '${otherUser.photo}')">
                  <img src="${otherUser.photo}" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
                  <div>
                      <b style="font-size:16px;">${otherUser.name}</b><br>
                      <span style="color:#888; font-size:13px;">${data.lastMessage || 'Start a conversation'}</span>
                  </div>
              </div>`;
          });
          list.innerHTML = html;
      });
  };

  window.openChatWindow = (chatId, name, photo) => {
      activeChatId = chatId;
      document.getElementById('view-conversation').style.display = 'block';
      document.getElementById('mainNav').style.display = 'none';
      document.getElementById('mainHeader').style.display = 'none';
      
      document.getElementById('chat-header-name').innerText = name;
      document.getElementById('chat-header-avatar').src = photo;
      
      const q = query(collection(db, `chats/${chatId}/messages`), orderBy("timestamp", "asc"));
      onSnapshot(q, (snap) => {
          const area = document.getElementById('chat-messages');
          let html = "";
          snap.forEach(d => {
              const msg = d.data();
              const type = msg.senderId === currentUser.uid ? 'me' : 'them';
              html += `<div style="display:flex; width:100%; justify-content:${type === 'me' ? 'flex-end' : 'flex-start'}">
                        <div class="chat-bubble ${type}">${msg.text}</div>
                       </div>`;
          });
          area.innerHTML = html;
          area.scrollTop = area.scrollHeight;
      });
  };

  window.closeChat = () => {
      activeChatId = null;
      document.getElementById('view-conversation').style.display = 'none';
      document.getElementById('mainNav').style.display = 'flex';
      document.getElementById('mainHeader').style.display = 'flex';
  };

  window.sendMessage = async () => {
      const txt = document.getElementById('messageInput').value;
      if(!txt.trim() || !activeChatId) return;
      document.getElementById('messageInput').value = "";
      
      await addDoc(collection(db, `chats/${activeChatId}/messages`), {
          text: txt, senderId: currentUser.uid, timestamp: serverTimestamp()
      });
      await updateDoc(doc(db, "chats", activeChatId), {
          lastMessage: txt, lastUpdated: serverTimestamp()
      });
  };

  // --- NOTIFICATIONS & JUMP ---
  function listenToNotifications(uid) {
      const q = query(collection(db, "notifications"), where("toUid", "==", uid), orderBy("timestamp", "desc"));
      onSnapshot(q, (snap) => {
          let html = "";
          let unread = 0;
          snap.forEach(d => {
              const n = d.data();
              if(!n.read) unread++;
              const icon = n.type === 'like' ? 'favorite' : (n.type === 'comment' ? 'chat' : 'person');
              const click = n.postId ? `onclick="jumpToPost('${n.postId}', '${d.id}')"` : `onclick="viewUserProfile('${n.fromUid}')"`;
              
              html += `
                <div class="notif-item ${n.read ? '' : 'unread'}" ${click}>
                    <span class="material-icons-round" style="color:var(--primary)">${icon}</span>
                    <div>
                        <b>${n.fromName}</b> ${n.type == 'like' ? 'liked your buzz' : (n.type == 'comment' ? 'commented' : 'followed you')}.
                    </div>
                </div>`;
          });
          document.getElementById('notif-list').innerHTML = html;
          document.getElementById('notif-badge').classList.toggle('visible', unread > 0);
      });
  }

  window.jumpToPost = async (postId, notifId) => {
      await updateDoc(doc(db, "notifications", notifId), { read: true });
      switchView('home');
      setTimeout(() => {
          const el = document.getElementById(`post-${postId}`);
          if(el) { el.scrollIntoView({behavior:'smooth', block:'center'}); openComments(postId, currentUser.uid); }
      }, 500);
  };

  // --- PROFILE ---
  window.viewUserProfile = (uid) => { loadProfile(uid); switchView('profile'); };

  async function loadProfile(targetUid) {
      const container = document.getElementById('profile-content');
      const uSnap = await getDoc(doc(db, "users", targetUid));
      if(!uSnap.exists()) return;
      const u = uSnap.data();
      
      const isMe = currentUser && currentUser.uid === targetUid;
      let followerCount = (await getDocs(collection(db, `users/${targetUid}/followers`))).size;
      let isFollowing = false;
      if(!isMe && currentUser) {
          const fSnap = await getDoc(doc(db, `users/${targetUid}/followers`, currentUser.uid));
          isFollowing = fSnap.exists();
      }

      let btns = "";
      if(isMe) {
          btns = `<button class="btn-profile btn-logout" onclick="doLogout()">Logout</button>`;
      } else {
          btns = `
            <button class="btn-profile ${isFollowing ? 'btn-following' : 'btn-follow'}" 
                onclick="toggleFollow('${targetUid}', ${isFollowing})">
                ${isFollowing ? 'Following' : 'Follow'}
            </button>
            <button class="btn-profile btn-message" onclick="startChat('${targetUid}', '${u.displayName}', '${u.photoURL}')">Message</button>
          `;
      }

      container.innerHTML = `
        <div class="profile-header">
            <img src="${u.photoURL}" class="profile-pic-lg">
            <h2>${u.displayName}</h2>
            <div class="stats"><div><b>${followerCount}</b><br><small>Followers</small></div></div>
            <div class="btn-group">${btns}</div>
        </div>`;
  }

  window.toggleFollow = async (targetUid, isFollowing) => {
      if(!currentUser) return login();
      const ref = doc(db, `users/${targetUid}/followers`, currentUser.uid);
      if(isFollowing) await deleteDoc(ref);
      else {
          await setDoc(ref, { timestamp: serverTimestamp() });
          sendNotif(targetUid, 'follow', null, null);
      }
      loadProfile(targetUid);
  };
</script>
</body>
</html>
