<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobuzzz - Media Update</title>
    <style>
        :root { --main-yellow: #FFD700; --bg: #FFFDF0; --gray: #888; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
        header { background: var(--main-yellow); padding: 15px; text-align: center; font-size: 24px; font-weight: bold; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; }
        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #eee; }
        .hidden { display: none; }

        /* Post & Profile Styling */
        .post { background: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .profile-pic { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--main-yellow); }
        .post-img { width: 100%; border-radius: 10px; margin-top: 10px; display: block; }
        
        /* Inputs */
        input[type="file"] { display: none; }
        .file-label { display: inline-block; padding: 8px 12px; background: #f0f0f0; border-radius: 10px; cursor: pointer; font-size: 14px; margin-top: 5px; }
        .btn-yellow { background: var(--main-yellow); border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* Bottom Nav */
        nav { display: flex; justify-content: space-around; background: white; padding: 12px 0; border-top: 2px solid var(--main-yellow); position: fixed; bottom: 0; width: 100%; z-index: 1000; }
        nav button { background: none; border: none; font-weight: bold; cursor: pointer; color: var(--gray); font-size: 16px; }
        nav button.active { color: #000; border-bottom: 2px solid var(--main-yellow); }
    </style>
</head>
<body>

<header>üêù Mobuzzz</header>

<div class="container">
    <div id="authSection" class="card">
        <button class="btn-yellow" onclick="login()" style="width:100%">Log in with Google</button>
    </div>

    <div id="usernameSetup" class="card hidden">
        <h3>Complete Your Profile üçØ</h3>
        <div style="text-align: center; margin-bottom: 15px;">
            <img id="setupPreview" src="https://via.placeholder.com/100" class="profile-pic" style="width:80px; height:80px;">
            <br>
            <label class="file-label" for="profileUpload">Choose Profile Picture</label>
            <input type="file" id="profileUpload" accept="image/*">
        </div>
        <input type="text" id="usernameInput" placeholder="username_ko" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
        <button class="btn-yellow" id="saveUsernameBtn" style="width:100%">Join the Hive</button>
    </div>

    <div id="postArea" class="card hidden">
        <textarea id="postInput" placeholder="What's the buzz?" style="width:100%; border:none; outline:none; resize:none; font-size:16px; min-height:50px;"></textarea>
        <div id="imagePreviewContainer" class="hidden">
            <img id="postImagePreview" style="width:100%; border-radius:10px; margin-bottom:10px;">
        </div>
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <label class="file-label" for="postImageUpload">üì∏ Add Photo</label>
            <input type="file" id="postImageUpload" accept="image/*">
            <button class="btn-yellow" id="postBtn">Buzz It!</button>
        </div>
    </div>

    <div id="feed"></div>
</div>

<nav id="bottomNav" class="hidden">
    <button id="navHome" class="active">üè† Home</button>
    <button id="navProfile">üë§ Profile</button>
</nav>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, getDoc, setDoc, where } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";

  // PASTE YOUR CONFIG HERE
  const firebaseConfig = {
    apiKey: "AIzaSyD7d5ShdJ6djY3V5mDinsiCYZcUnBGTQpk",
    authDomain: "mobuzzz-ce112.firebaseapp.com",
    projectId: "mobuzzz-ce112",
    storageBucket: "mobuzzz-ce112.firebasestorage.app",
    messagingSenderId: "1033041132259",
    appId: "1:1033041132259:web:df28b71b2d641a697923d6",
    measurementId: "G-Q7MJMFRDQF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;
  let currentUsername = "";
  let currentProfilePic = "";

  window.login = () => signInWithPopup(auth, provider);

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('authSection').classList.add('hidden');
      const userSnap = await getDoc(doc(db, "users", user.uid));
      if (userSnap.exists()) {
        currentUsername = userSnap.data().username;
        currentProfilePic = userSnap.data().photo || user.photoURL;
        startApp();
      } else {
        document.getElementById('usernameSetup').classList.remove('hidden');
        document.getElementById('setupPreview').src = user.photoURL;
      }
    }
  });

  // Profile Pic Preview & Setup
  const profileUpload = document.getElementById('profileUpload');
  profileUpload.onchange = (e) => {
    const file = e.target.files[0];
    if (file) document.getElementById('setupPreview').src = URL.createObjectURL(file);
  };

  document.getElementById('saveUsernameBtn').onclick = async () => {
    const input = document.getElementById('usernameInput').value.trim().toLowerCase();
    const file = profileUpload.files[0];
    if (input.length < 3) return alert("Too short!");

    let photoURL = currentUser.photoURL;
    if (file) {
      const sRef = ref(storage, `profiles/${currentUser.uid}`);
      await uploadBytes(sRef, file);
      photoURL = await getDownloadURL(sRef);
    }

    await setDoc(doc(db, "usernames", input), { uid: currentUser.uid });
    await setDoc(doc(db, "users", currentUser.uid), { username: input, photo: photoURL });
    currentUsername = input;
    currentProfilePic = photoURL;
    startApp();
  };

  // Post Image Preview
  const postImageUpload = document.getElementById('postImageUpload');
  postImageUpload.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      document.getElementById('postImagePreview').src = URL.createObjectURL(file);
      document.getElementById('imagePreviewContainer').classList.remove('hidden');
    }
  };

  // BUZZ IT (Post Logic with Image)
  document.getElementById('postBtn').onclick = async () => {
    const text = document.getElementById('postInput').value;
    const file = postImageUpload.files[0];
    if (!text.trim() && !file) return;

    let imageUrl = "";
    document.getElementById('postBtn').innerText = "Uploading...";

    if (file) {
      const sRef = ref(storage, `posts/${Date.now()}_${file.name}`);
      await uploadBytes(sRef, file);
      imageUrl = await getDownloadURL(sRef);
    }

    await addDoc(collection(db, "posts"), {
      content: text,
      user: currentUsername,
      userPhoto: currentProfilePic,
      postImage: imageUrl,
      timestamp: serverTimestamp()
    });

    document.getElementById('postInput').value = "";
    document.getElementById('postBtn').innerText = "Buzz It!";
    document.getElementById('imagePreviewContainer').classList.add('hidden');
    postImageUpload.value = "";
  };

  function startApp() {
    document.getElementById('usernameSetup').classList.add('hidden');
    document.getElementById('bottomNav').classList.remove('hidden');
    document.getElementById('postArea').classList.remove('hidden');
    loadFeed();
  }

  function loadFeed() {
    const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
    onSnapshot(q, (snapshot) => {
      const feed = document.getElementById('feed');
      feed.innerHTML = "";
      snapshot.forEach(postDoc => {
        const data = postDoc.data();
        feed.innerHTML += `
          <div class="post">
            <div class="post-header">
              <img class="profile-pic" src="${data.userPhoto || 'https://via.placeholder.com/45'}">
              <b>@${data.user}</b>
            </div>
            <div>${data.content}</div>
            ${data.postImage ? `<img class="post-img" src="${data.postImage}">` : ''}
          </div>
        `;
      });
    });
  }
</script>
</body>
</html>
