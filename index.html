<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobuzzz - Empire State</title>
    <style>
        :root { --main-yellow: #FFD700; --bg: #FFFDF0; --gray: #888; --blue-badge: #1DA1F2; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: #333; }
        
        header { background: var(--main-yellow); padding: 15px; text-align: center; font-size: 24px; font-weight: bold; position: sticky; top: 0; z-index: 2000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .container { padding: 12px; max-width: 500px; margin: 0 auto; }
        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #eee; }
        .hidden { display: none; }

        /* Verified Badge */
        .verified-badge { color: var(--blue-badge); font-size: 14px; margin-left: 4px; vertical-align: middle; }

        /* Post & Profile Styling */
        .post { background: white; padding: 15px; border-radius: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .profile-pic { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--main-yellow); cursor: pointer; }
        .post-img { width: 100%; border-radius: 10px; margin-top: 10px; display: block; }

        /* Messenger & Notifications UI */
        .notif-item { padding: 12px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .chat-room { height: 350px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 10px; background: #fafafa; border-radius: 10px; margin-bottom: 10px; }
        .bubble { padding: 8px 12px; border-radius: 15px; max-width: 75%; font-size: 14px; }
        .bubble-me { background: var(--main-yellow); align-self: flex-end; }
        .bubble-them { background: #eee; align-self: flex-start; }

        /* Navigation Icons */
        nav { display: flex; justify-content: space-around; background: white; padding: 12px 0; border-top: 2px solid var(--main-yellow); position: fixed; bottom: 0; width: 100%; z-index: 2000; }
        nav button { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--gray); position: relative; transition: 0.2s; }
        nav button.active { color: #000; transform: scale(1.2); }
        .badge-dot { position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background: red; border-radius: 50%; display: none; }

        .btn-yellow { background: var(--main-yellow); border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<header>üêù Mobuzzz</header>

<div class="container">
    <div id="authSection" class="card">
        <button class="btn-yellow" onclick="login()" style="width:100%">Enter the Empire</button>
    </div>

    <div id="homeView" class="tab-view">
        <div id="postArea" class="card hidden">
            <textarea id="postInput" placeholder="Anong buzz natin?" style="width:100%; border:none; outline:none; resize:none; font-size:16px; min-height:50px;"></textarea>
            <button class="btn-yellow" id="postBtn" style="float:right">Buzz It!</button>
            <div style="clear:both"></div>
        </div>
        <div id="feed"></div>
    </div>

    <div id="notifView" class="tab-view hidden">
        <div class="card">
            <h3>Notifications üîî</h3>
            <div id="notifList"></div>
        </div>
    </div>

    <div id="msgView" class="tab-view hidden">
        <div class="card">
            <h3 id="chatTitle">Messenger üí¨</h3>
            <div id="chatRoomArea" class="hidden">
                <div id="chatMessages" class="chat-room"></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="chatInput" placeholder="Write a message..." style="flex:1; padding:10px; border-radius:10px; border:1px solid #ddd;">
                    <button class="btn-yellow" id="sendMsgBtn">Send</button>
                </div>
            </div>
            <p id="noChatMsg" style="text-align:center; color:#888;">Visit a profile to start a chat!</p>
        </div>
    </div>

    <div id="profileView" class="tab-view hidden">
        <div class="card" style="text-align:center">
            <img id="p-pic" class="profile-pic" style="width:80px; height:80px;">
            <h2 id="p-user">@username</h2>
            <div id="profileActions" style="margin:15px 0;">
                <button id="followBtn" class="btn-yellow">Follow</button>
                <button id="dmBtn" class="btn-yellow" style="background:#eee">Message</button>
            </div>
            <div id="userPosts"></div>
        </div>
    </div>
</div>

<nav id="bottomNav" class="hidden">
    <button id="navHome" onclick="switchView('home')" class="active">üè†</button>
    <button id="navNotif" onclick="switchView('notif')">üîî<div id="notifDot" class="badge-dot"></div></button>
    <button id="navMsg" onclick="switchView('msg')">üí¨</button>
    <button id="navProfile" onclick="viewProfile(currentUsername)">üë§</button>
</nav>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, getDoc, setDoc, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD7d5ShdJ6djY3V5mDinsiCYZcUnBGTQpk",
    authDomain: "mobuzzz-ce112.firebaseapp.com",
    projectId: "mobuzzz-ce112",
    storageBucket: "mobuzzz-ce112.firebasestorage.app",
    messagingSenderId: "1033041132259",
    appId: "1:1033041132259:web:df28b71b2d641a697923d6",
    measurementId: "G-Q7MJMFRDQF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;
  let currentUsername = "";
  let activeChatId = null;

  // Blue Checkmark logic
  const checkmark = '<span class="verified-badge">‚úî</span>';
  const isVerified = (user) => user === "dugzhak" || user === "arnold23"; // Ilagay ang username mo rito

  window.login = () => signInWithPopup(auth, provider);

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('authSection').classList.add('hidden');
      const uSnap = await getDoc(doc(db, "users", user.uid));
      if (uSnap.exists()) {
        currentUsername = uSnap.data().username;
        startApp();
      } else {
        const name = prompt("Claim your @username:");
        if (name) {
          await setDoc(doc(db, "usernames", name.toLowerCase()), { uid: user.uid });
          await setDoc(doc(db, "users", user.uid), { username: name.toLowerCase(), photo: user.photoURL });
          location.reload();
        }
      }
    }
  });

  function startApp() {
    document.getElementById('bottomNav').classList.remove('hidden');
    document.getElementById('postArea').classList.remove('hidden');
    loadFeed();
    listenNotifs();
  }

  // --- NOTIFICATIONS ---
  function listenNotifs() {
    const q = query(collection(db, "users", currentUser.uid, "notifs"), orderBy("time", "desc"), limit(15));
    onSnapshot(q, s => {
      const list = document.getElementById('notifList');
      list.innerHTML = "";
      if (!s.empty) document.getElementById('notifDot').style.display = 'block';
      s.forEach(d => {
        list.innerHTML += `<div class="notif-item">üî• <b>@${d.data().from}</b> ${d.data().msg}</div>`;
      });
    });
  }

  async function pushNotif(targetUid, msg) {
    if (targetUid === currentUser.uid) return;
    await addDoc(collection(db, "users", targetUid, "notifs"), { from: currentUsername, msg: msg, time: serverTimestamp() });
  }

  // --- FEED ---
  function loadFeed() {
    const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
    onSnapshot(q, s => {
      const feed = document.getElementById('feed');
      feed.innerHTML = "";
      s.forEach(d => {
        const data = d.data();
        feed.innerHTML += `
          <div class="post">
            <div class="post-header">
                <img src="${data.userPhoto}" class="profile-pic" onclick="viewProfile('${data.user}')">
                <b onclick="viewProfile('${data.user}')">@${data.user}${isVerified(data.user) ? checkmark : ''}</b>
            </div>
            <div>${data.content}</div>
          </div>`;
      });
    });
  }

  // --- PROFILE & FOLLOW ---
  window.viewProfile = async (username) => {
    switchView('profile');
    const uSnap = await getDocs(query(collection(db, "users"), where("username", "==", username)));
    uSnap.forEach(async d => {
        document.getElementById('p-user').innerHTML = "@" + username + (isVerified(username) ? checkmark : '');
        document.getElementById('p-pic').src = d.data().photo;
        document.getElementById('profileActions').classList.toggle('hidden', username === currentUsername);
        
        document.getElementById('followBtn').onclick = () => {
            pushNotif(d.id, "started following you!");
            alert("Followed @"+username);
        };
        document.getElementById('dmBtn').onclick = () => startChat(d.id, username);
    });
  }

  // --- MESSENGER ---
  async function startChat(targetUid, targetName) {
    switchView('msg');
    document.getElementById('noChatMsg').classList.add('hidden');
    document.getElementById('chatRoomArea').classList.remove('hidden');
    document.getElementById('chatTitle').innerText = "Chat with @" + targetName;
    
    activeChatId = [currentUser.uid, targetUid].sort().join("_");
    const q = query(collection(db, "chats", activeChatId, "messages"), orderBy("time", "asc"));
    onSnapshot(q, s => {
        const box = document.getElementById('chatMessages');
        box.innerHTML = "";
        s.forEach(m => {
            const isMe = m.data().sender === currentUser.uid;
            box.innerHTML += `<div class="bubble ${isMe ? 'bubble-me' : 'bubble-them'}">${m.data().text}</div>`;
        });
        box.scrollTop = box.scrollHeight;
    });
  }

  document.getElementById('sendMsgBtn').onclick = async () => {
    const input = document.getElementById('chatInput');
    if (!input.value.trim() || !activeChatId) return;
    await addDoc(collection(db, "chats", activeChatId, "messages"), { text: input.value, sender: currentUser.uid, time: serverTimestamp() });
    input.value = "";
  };

  // --- NAV SYSTEM ---
  window.switchView = (view) => {
    document.querySelectorAll('.tab-view').forEach(v => v.classList.add('hidden'));
    document.getElementById(view + 'View').classList.remove('hidden');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById('nav' + view.charAt(0).toUpperCase() + view.slice(1)).classList.add('active');
    if (view === 'notif') document.getElementById('notifDot').style.display = 'none';
  }

  document.getElementById('postBtn').onclick = async () => {
    const val = document.getElementById('postInput').value;
    if (!val.trim()) return;
    await addDoc(collection(db, "posts"), { content: val, user: currentUsername, userPhoto: currentUser.photoURL, timestamp: serverTimestamp() });
    document.getElementById('postInput').value = "";
  };
</script>
</body>
</html>
