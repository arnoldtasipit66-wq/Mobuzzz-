<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobuzzz</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFD700">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <style>
        :root { --main-yellow: #FFD700; --bg: #FFFDF0; --blue-badge: #1DA1F2; --danger: #ff4757; }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding-bottom: 90px; 
            color: #333;
            overscroll-behavior-y: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden; /* Prevent side scroll */
        }

        header { 
            background: var(--main-yellow); 
            padding: 15px; 
            text-align: center; 
            font-size: 22px; 
            font-weight: 900; 
            position: sticky; 
            top: 0; 
            z-index: 2000; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .container { padding: 10px; max-width: 500px; margin: 0 auto; }
        .card { background: white; padding: 15px; border-radius: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 15px; border: 1px solid #f0f0f0; }
        .hidden { display: none !important; }

        /* --- GAME FIX: ROTATION LOGIC --- */
        #gameView {
            position: relative;
            height: calc(100vh - 150px);
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        .game-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
            transition: 0.3s;
            background: black;
            border-radius: 15px;
            overflow: hidden;
        }

        .game-frame {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Class to trigger Landscape Mode */
        .landscape-mode {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100vh !important; /* Height becomes Width */
            height: 100vw !important; /* Width becomes Height */
            z-index: 5000;
            transform: rotate(90deg);
            transform-origin: top left;
            margin-left: 100vw; /* Push it back into view */
            border-radius: 0 !important;
        }

        /* Rotate Button */
        #rotateBtn {
            background: #222;
            color: white;
            border: 1px solid #444;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        /* -------------------------------- */

        /* Post Styling */
        .verified-badge { color: var(--blue-badge); font-size: 14px; margin-left: 4px; vertical-align: middle; }
        .profile-pic { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid var(--main-yellow); cursor: pointer; }
        .post { background: white; padding: 15px; border-radius: 18px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); position: relative; border: 1px solid #f5f5f5; }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .post-img { width: 100%; border-radius: 12px; margin-top: 10px; display: block; }
        .btn-delete { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #ccc; cursor: pointer; font-size: 16px; padding: 8px; }
        .action-bar { display: flex; justify-content: space-around; border-top: 1px solid #f9f9f9; padding-top: 12px; margin-top: 10px; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 14px; color: #666; display: flex; align-items: center; gap: 6px; font-weight: 600; }
        
        /* Notifs & Chat */
        .notif-item { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 12px; background: white; border-radius: 10px; margin-bottom: 5px; }
        .bubble { padding: 10px 14px; border-radius: 18px; max-width: 75%; font-size: 15px; margin-bottom: 6px; word-wrap: break-word; }
        .bubble-me { background: var(--main-yellow); align-self: flex-end; }
        .bubble-them { background: #f0f0f0; align-self: flex-start; }

        /* Nav */
        nav { display: flex; justify-content: space-around; background: white; padding: 15px 0; border-top: 1px solid #eee; position: fixed; bottom: 0; width: 100%; z-index: 2000; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
        nav button { background: none; border: none; font-size: 24px; cursor: pointer; color: #ccc; position: relative; transition: 0.2s; }
        nav button.active { color: #000; transform: translateY(-3px); }
        .badge-dot { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: red; border-radius: 50%; display: none; border: 2px solid white; }
        .btn-yellow { background: var(--main-yellow); border: none; padding: 10px 24px; border-radius: 25px; font-weight: bold; cursor: pointer; font-size: 14px; }
        
        input, textarea { font-family: inherit; }
    </style>
</head>
<body>

<header>üêù Mobuzzz</header>

<div class="container">
    <div id="authSection" class="card">
        <div style="text-align:center; padding:20px;">
            <h2>Welcome Hive!</h2>
            <button class="btn-yellow" onclick="login()" style="width:100%">Log in with Google</button>
        </div>
    </div>

    <div id="homeView" class="tab-view hidden">
        <div id="postArea" class="card">
            <textarea id="postInput" placeholder="What's happening?" style="width:100%; border:none; outline:none; resize:none; font-size:16px; min-height:60px;"></textarea>
            <div id="imagePreviewContainer" class="hidden"><img id="postImagePreview" style="width:100%; border-radius:10px; margin-bottom:10px;"></div>
            <div style="display:flex; justify-content: space-between; align-items: center; margin-top:10px; border-top:1px solid #f9f9f9; padding-top:10px;">
                <label for="postImageUpload" style="cursor:pointer; font-size:20px; padding:5px;">üì∑</label>
                <input type="file" id="postImageUpload" accept="image/*" style="display:none;">
                <button class="btn-yellow" id="postBtn">Buzz</button>
            </div>
        </div>
        <div id="feed" style="padding-bottom: 20px;"></div>
    </div>

    <div id="gameView" class="tab-view hidden">
        <button id="rotateBtn" onclick="toggleGameRotation()">üîÑ Rotate Screen (Fullscreen)</button>
        
        <div id="gameContainer" class="game-wrapper">
            <iframe src="https://arnoldtasipit66-wq.github.io/my-game-assets/" class="game-frame" title="Pinoy Pool"></iframe>
        </div>
        
        <p style="text-align:center; color:#888; font-size:12px; margin-top:10px;">
            Click <b>Rotate</b> and turn your phone sideways! üé±
        </p>
    </div>

    <div id="notifView" class="tab-view hidden">
        <h3 style="margin:10px;">Notifications</h3>
        <div id="notifList"></div>
    </div>

    <div id="msgView" class="tab-view hidden">
        <div class="card" style="height: calc(100vh - 180px); display:flex; flex-direction:column;">
            <h3 id="chatTitle" style="border-bottom:1px solid #eee; padding-bottom:10px; margin-top:0;">Messages</h3>
            <div id="chatRoomArea" class="hidden" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
                <div id="chatMessages" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; padding:10px; gap:5px;"></div>
                <div style="display:flex; gap:8px; padding-top:10px; border-top:1px solid #eee;">
                    <input type="text" id="chatInput" placeholder="Type a message..." style="flex:1; border:none; background:#f5f5f5; padding:12px; border-radius:20px; outline:none;">
                    <button class="btn-yellow" id="sendMsgBtn" style="padding:10px 15px;">‚û§</button>
                </div>
            </div>
            <p id="noChatMsg" style="text-align:center; color:#888; margin-top:50px;">Visit a profile to start chatting! üí¨</p>
        </div>
    </div>

    <div id="profileView" class="tab-view hidden">
        <div class="card" style="text-align:center">
            <img id="p-pic" class="profile-pic" style="width:100px; height:100px; border:4px solid var(--main-yellow);">
            <h2 id="p-user" style="margin:10px 0;">@username</h2>
            <div id="profileActions" style="margin-bottom:20px; display:flex; gap:10px; justify-content:center;">
                <button id="followBtn" class="btn-yellow">Follow</button>
                <button id="dmBtn" class="btn-yellow" style="background:#eee; color:#333;">Message</button>
            </div>
            <hr style="border:0; border-top:1px solid #eee; margin-bottom:15px;">
            <div id="userFeed"></div>
        </div>
    </div>
</div>

<nav id="bottomNav" class="hidden">
    <button id="navHome" onclick="switchView('home')" class="active">üè†</button>
    <button id="navGame" onclick="switchView('game')">üé±</button>
    <button id="navNotif" onclick="switchView('notif')">üîî<div id="notifDot" class="badge-dot"></div></button>
    <button id="navMsg" onclick="switchView('msg')">üí¨</button>
    <button id="navProfile" onclick="viewProfile(currentUsername)">üë§</button>
</nav>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, getDoc, setDoc, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD7d5ShdJ6djY3V5mDinsiCYZcUnBGTQpk",
    authDomain: "mobuzzz-ce112.firebaseapp.com",
    projectId: "mobuzzz-ce112",
    storageBucket: "mobuzzz-ce112.firebasestorage.app",
    messagingSenderId: "1033041132259",
    appId: "1:1033041132259:web:df28b71b2d641a697923d6",
    measurementId: "G-Q7MJMFRDQF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;
  let currentUsername = "";
  let currentProfilePic = "";
  let activeChatId = null;

  const verifiedList = ["dugzhak", "arnold23", "admin"]; 
  const getBadge = (user) => verifiedList.includes(user) ? '<span class="verified-badge">‚úî</span>' : '';

  window.login = () => signInWithPopup(auth, provider);
  
  // --- ROTATION LOGIC FOR GAME ---
  window.toggleGameRotation = () => {
    const game = document.getElementById('gameContainer');
    game.classList.toggle('landscape-mode');
    
    // Hide nav bar when in full landscape to prevent accidental clicks
    if (game.classList.contains('landscape-mode')) {
        document.getElementById('bottomNav').style.display = 'none';
        document.querySelector('header').style.display = 'none';
        document.getElementById('rotateBtn').innerText = "‚ùå Close Game";
        document.getElementById('rotateBtn').style.position = 'fixed';
        document.getElementById('rotateBtn').style.bottom = '10px';
        document.getElementById('rotateBtn').style.right = '10px';
        document.getElementById('rotateBtn').style.zIndex = '6000';
    } else {
        document.getElementById('bottomNav').style.display = 'flex';
        document.querySelector('header').style.display = 'block';
        document.getElementById('rotateBtn').innerText = "üîÑ Rotate Screen (Fullscreen)";
        document.getElementById('rotateBtn').style.position = 'static';
    }
  };

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('authSection').classList.add('hidden');
      const uSnap = await getDoc(doc(db, "users", user.uid));
      if (uSnap.exists()) {
        currentUsername = uSnap.data().username;
        currentProfilePic = uSnap.data().photo || user.photoURL;
        startApp();
      } else {
        const name = prompt("Username:");
        if (name) {
          await setDoc(doc(db, "usernames", name.toLowerCase()), { uid: user.uid });
          await setDoc(doc(db, "users", user.uid), { username: name.toLowerCase(), photo: user.photoURL });
          location.reload();
        }
      }
    }
  });

  function startApp() {
    document.getElementById('homeView').classList.remove('hidden');
    document.getElementById('bottomNav').classList.remove('hidden');
    loadFeed();
    listenNotifs();
  }

  // --- ACTIONS ---
  window.deletePost = async (id) => {
    if (confirm("Delete this buzz?")) await deleteDoc(doc(db, "posts", id));
  };

  window.like = async (id, targetUid) => {
    const lRef = doc(db, "posts", id, "likes", currentUser.uid);
    const snap = await getDoc(lRef);
    if (snap.exists()) {
        await deleteDoc(lRef);
    } else {
        await setDoc(lRef, { u: currentUsername });
        pushNotif(targetUid, "liked your buzz! ‚ù§Ô∏è");
    }
  };

  window.addComment = async (id, targetUid) => {
    const val = document.getElementById(`c-in-${id}`).value;
    if (!val.trim()) return;
    await addDoc(collection(db, "posts", id, "comments"), { text: val, user: currentUsername, timestamp: serverTimestamp() });
    document.getElementById(`c-in-${id}`).value = "";
    pushNotif(targetUid, "commented on your buzz üí¨");
  };

  async function pushNotif(targetUid, msg) {
    if(targetUid === currentUser.uid) return; 
    await addDoc(collection(db, targetUid, "notifs"), { from: currentUsername, msg: msg, time: serverTimestamp() });
  }

  function listenNotifs() {
    onSnapshot(query(collection(db, currentUser.uid, "notifs"), orderBy("time", "desc")), s => {
      const list = document.getElementById('notifList');
      list.innerHTML = "";
      if (!s.empty) document.getElementById('notifDot').style.display = 'block';
      s.forEach(d => list.innerHTML += `
        <div class="notif-item">
            <div style="font-size:20px;">üîî</div>
            <div><b>@${d.data().from}</b> ${d.data().msg}</div>
        </div>`);
    });
  }

  function loadFeed() {
    const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
    onSnapshot(q, s => {
      const feed = document.getElementById('feed');
      feed.innerHTML = "";
      s.forEach(postDoc => {
        const d = postDoc.data();
        const id = postDoc.id;
        const deleteBtn = (currentUser && d.uid === currentUser.uid) ? `<button class="btn-delete" onclick="deletePost('${id}')">üóëÔ∏è</button>` : '';
        const div = document.createElement('div');
        div.className = 'post';
        div.innerHTML = `
          ${deleteBtn}
          <div class="post-header">
            <img src="${d.userPhoto}" class="profile-pic" onclick="viewProfile('${d.user}')">
            <div onclick="viewProfile('${d.user}')">
                <b style="font-size:15px;">@${d.user}${getBadge(d.user)}</b><br>
                <span style="font-size:11px; color:#999;">Hive Member</span>
            </div>
          </div>
          <div class="post-content">${d.content}</div>
          ${d.postImage ? `<img class="post-img" src="${d.postImage}">` : ''}
          <div class="action-bar">
            <button class="action-btn" onclick="like('${id}', '${d.uid}')">‚ù§Ô∏è <span id="l-${id}">0</span></button>
            <button class="action-btn" onclick="document.getElementById('c-sec-${id}').classList.toggle('hidden')">üí¨ <span id="cc-${id}">0</span></button>
          </div>
          <div id="c-sec-${id}" class="comment-section hidden">
            <div id="c-list-${id}"></div>
            <div style="display:flex; gap:8px; margin-top:10px;">
              <input type="text" id="c-in-${id}" placeholder="Comment..." style="flex:1; border:none; background:#f5f5f5; padding:8px 12px; border-radius:15px; outline:none;">
              <button class="btn-yellow" style="padding:5px 15px;" onclick="addComment('${id}', '${d.uid}')">‚û§</button>
            </div>
          </div>
        `;
        feed.appendChild(div);
        initInteractions(id);
      });
    });
  }

  function initInteractions(postId) {
    onSnapshot(collection(db, "posts", postId, "likes"), s => document.getElementById(`l-${postId}`).innerText = s.size);
    onSnapshot(query(collection(db, "posts", postId, "comments"), orderBy("timestamp", "asc")), s => {
      document.getElementById(`cc-${postId}`).innerText = s.size;
      const list = document.getElementById(`c-list-${postId}`);
      list.innerHTML = "";
      s.forEach(c => list.innerHTML += `<div style="margin-bottom:5px; font-size:13px;"><b>@${c.data().user}</b> ${c.data().text}</div>`);
    });
  }

  window.viewProfile = async (un) => {
    switchView('profile');
    const uSnap = await getDocs(query(collection(db, "users"), where("username", "==", un)));
    uSnap.forEach(d => {
        document.getElementById('p-user').innerHTML = "@" + un + getBadge(un);
        document.getElementById('p-pic').src = d.data().photo;
        const isMe = un === currentUsername;
        document.getElementById('profileActions').style.display = isMe ? 'none' : 'flex';
        document.getElementById('followBtn').onclick = () => { pushNotif(d.id, "started following you! üöÄ"); alert("Following!"); };
        document.getElementById('dmBtn').onclick = () => startChat(d.id, un);
    });
    const pSnap = await getDocs(query(collection(db, "posts"), where("user", "==", un), orderBy("timestamp", "desc")));
    const uFeed = document.getElementById('userFeed'); uFeed.innerHTML = "";
    pSnap.forEach(doc => { uFeed.innerHTML += `<div class="post"><div class="post-content">${doc.data().content}</div></div>`; });
  }

  async function startChat(targetUid, targetName) {
    switchView('msg');
    document.getElementById('noChatMsg').classList.add('hidden');
    document.getElementById('chatRoomArea').classList.remove('hidden');
    document.getElementById('chatTitle').innerText = "@" + targetName;
    activeChatId = [currentUser.uid, targetUid].sort().join("_");
    onSnapshot(query(collection(db, "chats", activeChatId, "messages"), orderBy("time", "asc")), s => {
        const box = document.getElementById('chatMessages'); box.innerHTML = "";
        s.forEach(m => {
            const isMe = m.data().sender === currentUser.uid;
            box.innerHTML += `<div class="bubble ${isMe ? 'bubble-me' : 'bubble-them'}">${m.data().text}</div>`;
        });
        box.scrollTop = box.scrollHeight;
    });
  }

  document.getElementById('sendMsgBtn').onclick = async () => {
    const input = document.getElementById('chatInput');
    if (!input.value.trim() || !activeChatId) return;
    await addDoc(collection(db, "chats", activeChatId, "messages"), { text: input.value, sender: currentUser.uid, time: serverTimestamp() });
    input.value = "";
  };

  window.switchView = (v) => {
    document.querySelectorAll('.tab-view').forEach(view => view.classList.add('hidden'));
    document.getElementById(v + 'View').classList.remove('hidden');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById('nav' + v.charAt(0).toUpperCase() + v.slice(1)).classList.add('active');
    if (v === 'notif') document.getElementById('notifDot').style.display = 'none';
    
    // Reset rotation if leaving game tab
    if (v !== 'game') {
         document.getElementById('gameContainer').classList.remove('landscape-mode');
         document.getElementById('bottomNav').style.display = 'flex';
         document.querySelector('header').style.display = 'block';
         document.getElementById('rotateBtn').innerText = "üîÑ Rotate Screen (Fullscreen)";
         document.getElementById('rotateBtn').style.position = 'static';
    }
  }

  document.getElementById('postBtn').onclick = async () => {
    const text = document.getElementById('postInput').value;
    const file = document.getElementById('postImageUpload').files[0];
    if (!text.trim() && !file) return;

    let imageUrl = "";
    if (file) {
      try {
        const sRef = ref(storage, `posts/${Date.now()}`);
        await uploadBytes(sRef, file);
        imageUrl = await getDownloadURL(sRef);
      } catch (e) { console.log("Storage limit"); }
    }
    
    await addDoc(collection(db, "posts"), { 
        content: text, user: currentUsername, userPhoto: currentProfilePic, 
        postImage: imageUrl, uid: currentUser.uid, timestamp: serverTimestamp() 
    });
    document.getElementById('postInput').value = "";
    document.getElementById('postImageUpload').value = "";
    document.getElementById('imagePreviewContainer').classList.add('hidden');
  };

  document.getElementById('postImageUpload').onchange = (e) => {
      if(e.target.files[0]) {
        document.getElementById('postImagePreview').src = URL.createObjectURL(e.target.files[0]);
        document.getElementById('imagePreviewContainer').classList.remove('hidden');
      }
  };
</script>
</body>
</html>
