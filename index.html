<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mobuzzz Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFD700">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default"> 
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root { --primary: #FFD700; --bg: #f8f9fa; --text: #212529; --gray: #6c757d; --white: #ffffff; --blue: #0099ff; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); color: var(--text); margin: 0; padding: 0; 
            padding-bottom: calc(75px + env(safe-area-inset-bottom)); 
            overscroll-behavior-y: none; user-select: none; -webkit-user-select: none;
        }
        
        /* HEADER */
        header { 
            background: var(--white); padding: 15px; position: sticky; top: 0; z-index: 100; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; 
            padding-top: calc(15px + env(safe-area-inset-top));
        }
        h1 { margin: 0; font-size: 20px; font-weight: 800; color: #000; letter-spacing: -0.5px; }
        .brand span { color: #f39c12; }
        
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .view-section { display: none; animation: fadeIn 0.2s ease-out; }
        .view-section.active { display: block; }

        /* POST FEED */
        .post-card { background: var(--white); border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid #eee; }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); cursor: pointer; }
        .user-meta { flex: 1; }
        .user-name { font-weight: 700; font-size: 15px; display: block; }
        .post-time { font-size: 12px; color: var(--gray); }
        .post-content { font-size: 15px; line-height: 1.5; margin-bottom: 15px; white-space: pre-wrap; }
        .post-actions { display: flex; justify-content: space-between; border-top: 1px solid #f0f0f0; padding-top: 10px; }
        .action-btn { background: none; border: none; display: flex; align-items: center; gap: 5px; color: var(--gray); font-size: 14px; cursor: pointer; padding: 5px 10px; border-radius: 20px; transition: background 0.2s; }
        .action-btn:hover { background: #f8f9fa; }
        .action-btn.liked { color: #e91e63; }

        /* NOTIFICATIONS */
        .notif-item { background: white; padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: background 0.2s; }
        .notif-item:active { background: #f0f0f0; }
        .notif-item.unread { background: #fffde7; border-left: 4px solid var(--primary); }
        .red-dot { width: 10px; height: 10px; background: #ff4444; border-radius: 50%; position: absolute; top: 5px; right: 25%; border: 2px solid white; display: none; }
        .red-dot.visible { display: block; }

        /* CHAT & MESSAGES */
        .chat-list-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: white; border-bottom: 1px solid #eee; cursor: pointer; }
        .chat-list-item:hover { background: #f9f9f9; }
        .chat-bubble { max-width: 70%; padding: 10px 15px; border-radius: 18px; margin-bottom: 5px; font-size: 14px; line-height: 1.4; position: relative; word-wrap: break-word; }
        .chat-bubble.me { background: var(--blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-bubble.them { background: #e4e6eb; color: black; align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 140px); overflow-y: auto; padding: 10px; gap: 5px; }
        .chat-input-area { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; gap: 10px; align-items: center; padding-bottom: calc(10px + env(safe-area-inset-bottom)); z-index: 2000; }

        /* GAME MODE */
        body.game-mode { background: #000; padding: 0 !important; overflow: hidden; }
        body.game-mode header, body.game-mode .bottom-nav, body.game-mode .fab, body.game-mode .container { display: none !important; }
        .game-wrapper { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 5000; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .game-frame { width: 100vh; height: 100vw; transform: rotate(90deg); transform-origin: center; border: none; position: absolute; }
        .game-exit-btn { position: fixed; top: 20px; right: 90px; background: rgba(255, 68, 68, 0.9); color: white; border: 2px solid white; width: 40px; height: 40px; border-radius: 50%; z-index: 6000; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.5); transform: rotate(90deg); }
        .rotate-hint { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 5002; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; pointer-events: none; transition: opacity 0.5s ease; }
        .rotate-content { transform: rotate(90deg); text-align: center; }

        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--white); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000; border-top: 1px solid #eee; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { border: none; background: none; color: var(--gray); display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; cursor: pointer; width: 20%; }
        .nav-item.active { color: #000; font-weight: bold; }
        .nav-item .material-icons-round { font-size: 26px; }

        /* FAB */
        .fab { position: fixed; bottom: calc(75px + env(safe-area-inset-bottom)); right: 20px; background: var(--primary); color: #000; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(255, 215, 0, 0.4); cursor: pointer; z-index: 900; border: none; font-weight: bold; }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: flex-end; }
        .modal-content { background: white; width: 100%; max-width: 600px; border-radius: 20px 20px 0 0; padding: 20px; padding-bottom: calc(20px + env(safe-area-inset-bottom)); animation: slideUp 0.3s ease; max-height: 80vh; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* COMMENTS */
        .comment-list { flex: 1; overflow-y: auto; margin-bottom: 10px; max-height: 40vh; }
        .comment-item { display: flex; gap: 10px; margin-bottom: 10px; font-size: 14px; }
        .comment-item.reply { margin-left: 40px; border-left: 2px solid #eee; padding-left: 10px; }
        .comment-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        .reply-tag { font-size: 11px; background: #eee; padding: 2px 6px; border-radius: 4px; margin-right: 5px; color: #555; }

        /* PROFILE */
        .profile-header { text-align: center; padding: 30px 20px; background: white; border-radius: 0 0 20px 20px; margin-bottom: 15px; }
        .profile-pic-lg { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--primary); margin-bottom: 10px; object-fit: cover; }
        .stats { display: flex; justify-content: center; gap: 20px; margin: 15px 0; }
        .btn-follow { background: #000; color: #fff; border: none; padding: 8px 24px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .btn-follow.following { background: white; color: #000; border: 1px solid #ddd; }
        .btn-msg { background: var(--blue); color: white; border: none; padding: 8px 24px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-left: 5px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<header id="mainHeader">
    <div class="brand"><h1>üêù Mobuzzz<span>Pro</span></h1></div>
    <div id="authBtnContainer"></div>
</header>

<button class="game-exit-btn" id="gameExitBtn" onclick="showExitConfirm()" style="display:none;">
    <span class="material-icons-round">close</span>
</button>
<div id="exitConfirmModal" class="exit-confirm-modal" style="display:none;">
    <div class="exit-box">
        <span class="material-icons-round" style="font-size:48px; color:#d32f2f;">warning</span>
        <h3>Exit Game?</h3>
        <p>Are you sure you want to close Pinoy Pool?</p>
        <div class="exit-actions">
            <button class="btn-stay" onclick="closeExitConfirm()">Cancel</button>
            <button class="btn-leave" onclick="confirmExitGame()">Yes, Exit</button>
        </div>
    </div>
</div>
<div id="view-games" class="view-section">
    <div class="game-wrapper">
        <div id="loadingCurtain" class="rotate-hint">
            <div class="rotate-content">
                <span class="material-icons-round" style="font-size:48px; display:block; margin-bottom:10px;">screen_rotation</span> 
                <h2>Loading Game...</h2>
                <p>Rotate Phone</p>
            </div>
        </div>
        <iframe src="https://arnoldtasipit66-wq.github.io/my-game-assets/" class="game-frame" title="Pinoy Pool"></iframe>
    </div>
</div>

<div class="container">
    <div id="view-home" class="view-section active">
        <div id="feed"><p style="text-align:center; padding:20px;">Connecting to Hive...</p></div>
    </div>

    <div id="view-messages" class="view-section">
        <h2 style="padding: 0 10px;">Messages</h2>
        <div id="inbox-list">
            <p style="text-align:center; margin-top:50px; color:#888;">No conversations yet.</p>
        </div>
    </div>

    <div id="view-notifications" class="view-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">Notifications</h3>
            <button onclick="markAllRead()" style="background:none; border:none; color:var(--primary); font-weight:bold; cursor:pointer;">Mark read</button>
        </div>
        <div id="notif-list"><p style="text-align:center;">No updates.</p></div>
    </div>

    <div id="view-profile" class="view-section">
        <div id="profile-content"></div>
    </div>
</div>

<div id="view-conversation" class="view-section" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:2000; display:none;">
    <div style="background:white; padding:15px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:10px; padding-top:calc(15px + env(safe-area-inset-top));">
        <button onclick="closeChat()" style="background:none; border:none;"><span class="material-icons-round">arrow_back</span></button>
        <img id="chat-header-avatar" src="" style="width:30px; height:30px; border-radius:50%;">
        <b id="chat-header-name">User</b>
    </div>
    <div id="chat-messages" class="chat-container"></div>
    <div class="chat-input-area">
        <input type="text" id="messageInput" placeholder="Type a message..." style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd; outline:none;">
        <button onclick="sendMessage()" style="background:var(--blue); color:white; border:none; padding:10px; border-radius:50%; display:flex;"><span class="material-icons-round">send</span></button>
    </div>
</div>

<button class="fab" id="fabPost"><span class="material-icons-round">add</span></button>

<nav class="bottom-nav" id="mainNav">
    <button class="nav-item active" onclick="switchView('home')"><span class="material-icons-round">home</span></button>
    <button class="nav-item" onclick="switchView('games')"><span class="material-icons-round">sports_esports</span></button>
    <button class="nav-item" onclick="switchView('messages')"><span class="material-icons-round">mail</span></button>
    <button class="nav-item" onclick="switchView('notifications')">
        <span class="material-icons-round">notifications</span><span id="notif-badge" class="red-dot"></span>
    </button>
    <button class="nav-item" onclick="switchView('profile')"><span class="material-icons-round">person</span></button>
</nav>

<div id="postModal" class="modal" onclick="closeModal(event, 'postModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>Create Buzz</h3>
        <textarea id="postInput" placeholder="What's buzzing?" style="width:100%; height:100px; border:1px solid #ddd; padding:10px; border-radius:10px; box-sizing:border-box;"></textarea>
        <div style="text-align:right; margin-top:10px;">
            <button onclick="document.getElementById('postModal').style.display='none'" style="margin-right:10px; background:none; border:none;">Cancel</button>
            <button id="submitPostBtn" style="background:var(--primary); border:none; padding:8px 20px; border-radius:20px; font-weight:bold;">Post</button>
        </div>
    </div>
</div>

<div id="commentModal" class="modal" onclick="closeModal(event, 'commentModal')">
    <div class="modal-content" style="height: 60vh;" onclick="event.stopPropagation()">
        <div style="width:40px; height:4px; background:#eee; border-radius:2px; margin:0 auto 15px auto;"></div>
        <h3 style="margin-top:0;">Comments</h3>
        <div id="commentList" class="comment-list"></div>
        <div id="replyingToBanner" style="font-size:12px; color:var(--blue); padding:5px 0; display:none;">Replying to... <span onclick="cancelReply()" style="float:right; cursor:pointer;">&times;</span></div>
        <div style="display:flex; gap:10px; margin-top:auto;">
            <input type="text" id="commentInput" placeholder="Write a comment..." style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd; outline:none;">
            <button id="sendCommentBtn" style="background:var(--primary); border:none; border-radius:50%; width:40px; height:40px; font-weight:bold; cursor:pointer;">‚û§</button>
        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, arrayUnion, arrayRemove, serverTimestamp, query, orderBy, where, onSnapshot, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD7d5ShdJ6djY3V5mDinsiCYZcUnBGTQpk",
    authDomain: "mobuzzz-ce112.firebaseapp.com",
    projectId: "mobuzzz-ce112",
    storageBucket: "mobuzzz-ce112.firebasestorage.app",
    messagingSenderId: "1033041132259",
    appId: "1:1033041132259:web:df28b71b2d641a697923d6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  
  try { enableIndexedDbPersistence(db).catch(err => console.log("Persistence error:", err.code)); } catch(e) {}

  let currentUser = null;
  let activeChatId = null;
  let activePostId = null;
  let replyingToCommentId = null; // Para sa reply logic

  // --- NAVIGATION ---
  window.switchView = (viewName) => {
    // Hide specialized views first
    document.getElementById('view-conversation').style.display = 'none';
    document.getElementById('mainNav').style.display = 'flex';
    document.getElementById('mainHeader').style.display = 'flex';

    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    
    if(viewName === 'games') {
        document.body.classList.add('game-mode');
        document.getElementById('view-games').classList.add('active');
        document.getElementById('gameExitBtn').style.display = 'flex';
        document.querySelectorAll('.nav-item')[1].classList.add('active');
        const curtain = document.getElementById('loadingCurtain');
        if(curtain) {
            curtain.style.display = 'flex'; curtain.style.opacity = '1';
            setTimeout(() => { curtain.style.opacity = '0'; setTimeout(() => curtain.style.display = 'none', 500); }, 4500);
        }
        return; 
    } else {
        document.body.classList.remove('game-mode'); 
        document.getElementById('gameExitBtn').style.display = 'none';
        document.getElementById('exitConfirmModal').style.display = 'none';
    }

    document.getElementById(`view-${viewName}`).classList.add('active');
    const index = ['home', 'games', 'messages', 'notifications', 'profile'].indexOf(viewName);
    if(index >= 0) document.querySelectorAll('.nav-item')[index].classList.add('active');

    if(viewName === 'profile' && currentUser) loadProfile(currentUser.uid);
    if(viewName === 'messages' && currentUser) loadInbox();
  };

  window.closeModal = (event, id) => {
      if(event.target.id === id) document.getElementById(id).style.display = 'none';
  };
  window.showExitConfirm = () => document.getElementById('exitConfirmModal').style.display = 'flex';
  window.closeExitConfirm = () => document.getElementById('exitConfirmModal').style.display = 'none';
  window.confirmExitGame = () => { window.closeExitConfirm(); window.switchView('home'); };

  document.getElementById('fabPost').onclick = () => currentUser ? document.getElementById('postModal').style.display = 'flex' : login();
  const login = () => signInWithPopup(auth, new GoogleAuthProvider());
  window.doLogout = () => signOut(auth).then(() => window.location.reload());

  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    const container = document.getElementById('authBtnContainer');
    if (user) {
      container.innerHTML = `<img src="${user.photoURL}" style="width:32px; height:32px; border-radius:50%; border:2px solid #ddd;" onclick="switchView('profile')">`;
      await setDoc(doc(db, "users", user.uid), { displayName: user.displayName, photoURL: user.photoURL, email: user.email }, { merge: true });
      listenToNotifications(user.uid);
    } else {
      container.innerHTML = `<button onclick="login()" style="background:#000; color:white; border:none; padding:8px 15px; border-radius:15px; font-weight:bold;">Login</button>`;
      window.login = login; 
    }
  });

  // --- POSTS ---
  document.getElementById('submitPostBtn').onclick = async () => {
      const text = document.getElementById('postInput').value;
      if(!text.trim()) return;
      document.getElementById('postModal').style.display = 'none';
      await addDoc(collection(db, "posts"), {
          content: text, timestamp: serverTimestamp(), uid: currentUser.uid,
          authorName: currentUser.displayName, authorPhoto: currentUser.photoURL,
          likes: [], commentsCount: 0
      });
      document.getElementById('postInput').value = "";
  };

  const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
  onSnapshot(q, (snapshot) => {
      const feed = document.getElementById('feed');
      let html = "";
      snapshot.forEach(doc => {
          const p = doc.data();
          const isLiked = p.likes && currentUser && p.likes.includes(currentUser.uid);
          html += `
            <div class="post-card" id="post-${doc.id}">
                <div class="post-header">
                    <img src="${p.authorPhoto}" class="user-avatar" onclick="viewUserProfile('${p.uid}')">
                    <div class="user-meta">
                        <b onclick="viewUserProfile('${p.uid}')">${p.authorName}</b>
                        <div class="post-time">${p.timestamp ? new Date(p.timestamp.toDate()).toLocaleTimeString() : '...'}</div>
                    </div>
                </div>
                <div class="post-content">${p.content}</div>
                <div class="post-actions">
                    <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${doc.id}', ${isLiked}, '${p.uid}')">
                        <span class="material-icons-round">${isLiked ? 'favorite' : 'favorite_border'}</span> ${p.likes ? p.likes.length : 0}
                    </button>
                    <button class="action-btn" onclick="openComments('${doc.id}', '${p.uid}')">
                        <span class="material-icons-round">chat_bubble_outline</span> ${p.commentsCount || 0}
                    </button>
                </div>
            </div>`;
      });
      feed.innerHTML = html;
  });

  // --- LIKES & NOTIFS ---
  window.toggleLike = async (postId, isLiked, ownerId) => {
      if(!currentUser) return login();
      const ref = doc(db, "posts", postId);
      if(isLiked) {
          await updateDoc(ref, { likes: arrayRemove(currentUser.uid) });
      } else {
          await updateDoc(ref, { likes: arrayUnion(currentUser.uid) });
          if(ownerId !== currentUser.uid) sendNotif(ownerId, 'like', postId, null);
      }
  };

  async function sendNotif(toUid, type, postId, extraData) {
      await addDoc(collection(db, "notifications"), {
          toUid, fromUid: currentUser.uid, fromName: currentUser.displayName,
          type, postId, read: false, timestamp: serverTimestamp(), ...extraData
      });
  }

  // --- REPLY & COMMENTS SYSTEM ---
  window.cancelReply = () => {
      replyingToCommentId = null;
      document.getElementById('replyingToBanner').style.display = 'none';
      document.getElementById('commentInput').placeholder = "Write a comment...";
  };

  window.setReply = (commentId, authorName) => {
      replyingToCommentId = commentId;
      document.getElementById('replyingToBanner').style.display = 'block';
      document.getElementById('replyingToBanner').innerHTML = `Replying to <b>${authorName}</b> <span onclick="cancelReply()" style="float:right; cursor:pointer;">&times;</span>`;
      document.getElementById('commentInput').focus();
  };

  window.openComments = (postId, postOwnerId) => {
      activePostId = postId;
      cancelReply(); // Reset logic
      document.getElementById('commentModal').style.display = 'flex';
      
      const q = query(collection(db, `posts/${postId}/comments`), orderBy("timestamp", "asc"));
      onSnapshot(q, (snap) => {
          const list = document.getElementById('commentList');
          list.innerHTML = "";
          
          let comments = [];
          snap.forEach(d => comments.push({ id: d.id, ...d.data() }));

          // Render: Simple Indentation for Replies
          comments.forEach(c => {
              const isReply = c.replyToId ? 'reply' : '';
              const replyTag = c.replyToName ? `<span class="reply-tag">@${c.replyToName}</span>` : '';
              
              list.innerHTML += `
              <div class="comment-item ${isReply}">
                <img src="${c.photo}" class="comment-avatar">
                <div style="width:100%">
                    <div style="background:#f0f2f5; padding:8px 12px; border-radius:15px; width:fit-content; max-width:100%;">
                        <b>${c.user}</b><br>${replyTag}${c.text}
                    </div>
                    <div style="margin-top:2px;">
                        <button onclick="setReply('${c.id}', '${c.user}')" style="background:none; border:none; color:#555; font-size:12px; font-weight:bold; cursor:pointer; padding:0 5px;">Reply</button>
                    </div>
                </div>
              </div>`;
          });
      });
  
      // Update Send Button Logic
      const sendBtn = document.getElementById('sendCommentBtn');
      sendBtn.onclick = async () => {
          const txt = document.getElementById('commentInput').value;
          if(!txt.trim()) return;
          
          let commentData = {
              text: txt, user: currentUser.displayName, photo: currentUser.photoURL, timestamp: serverTimestamp()
          };

          if(replyingToCommentId) {
              // Get parent comment data to allow deep nesting visualization if needed
              // But for now, we just tag it
              commentData.replyToId = replyingToCommentId;
              // We could fetch the name from UI or DB, simplifying to just generic reply for speed or pass name in setReply
              // Let's rely on setReply's visual cue. Ideally we'd store who we are replying to.
              const banner = document.getElementById('replyingToBanner').innerText;
              if(banner.includes("Replying to")) {
                  commentData.replyToName = banner.split("Replying to ")[1].split(" ")[0].trim();
              }
          }

          await addDoc(collection(db, `posts/${activePostId}/comments`), commentData);
          
          const postRef = doc(db, "posts", activePostId);
          const postSnap = await getDoc(postRef);
          await updateDoc(postRef, { commentsCount: (postSnap.data().commentsCount || 0) + 1 });
          
          if(postOwnerId !== currentUser.uid) sendNotif(postOwnerId, 'comment', activePostId, null);
          
          document.getElementById('commentInput').value = "";
          cancelReply();
      };
  };

  // --- NOTIFICATIONS & JUMP TO POST ---
  function listenToNotifications(uid) {
      const q = query(collection(db, "notifications"), where("toUid", "==", uid), orderBy("timestamp", "desc"));
      onSnapshot(q, (snap) => {
          let html = "";
          let unreadCount = 0;
          snap.forEach(d => {
              const n = d.data();
              if(!n.read) unreadCount++;
              
              let icon = n.type == 'like' ? 'favorite' : (n.type == 'comment' ? 'chat' : 'person');
              let text = n.type == 'like' ? 'liked your buzz' : (n.type == 'comment' ? 'commented on your buzz' : 'started following you');
              
              // Onclick Logic: Go to Post
              let clickAction = "";
              if(n.postId) {
                  clickAction = `onclick="jumpToPost('${n.postId}', '${d.id}')"`;
              } else if (n.type === 'follow') {
                   clickAction = `onclick="viewUserProfile('${n.fromUid}'); markReadOne('${d.id}')"`;
              }

              html += `
                <div class="notif-item ${n.read ? '' : 'unread'}" ${clickAction}>
                    <span class="material-icons-round" style="color:var(--primary)">${icon}</span>
                    <div>
                        <b>${n.fromName}</b> ${text}.
                        <small style="display:block; color:#888;">${n.timestamp ? new Date(n.timestamp.toDate()).toLocaleTimeString() : ''}</small>
                    </div>
                </div>`;
          });
          document.getElementById('notif-list').innerHTML = html;
          
          const badge = document.getElementById('notif-badge');
          if(unreadCount > 0) badge.classList.add('visible');
          else badge.classList.remove('visible');
      });
  }

  // --- JUMP LOGIC ---
  window.jumpToPost = async (postId, notifId) => {
      // 1. Mark notification read
      await updateDoc(doc(db, "notifications", notifId), { read: true });
      
      // 2. Go to Home
      switchView('home');
      
      // 3. Scroll to post or Open Comment
      const postEl = document.getElementById(`post-${postId}`);
      if(postEl) {
          postEl.scrollIntoView({behavior: "smooth", block: "center"});
          postEl.style.border = "2px solid var(--primary)";
          setTimeout(() => postEl.style.border = "1px solid #eee", 2000);
      } else {
          // If post not loaded in feed yet (because of limit), simpler to just open comment modal directly?
          // Since we are loading all posts (bad practice but okay for now), it should be there.
          // Let's trigger "openComments" since user wants to see the interaction
          // We need the owner ID. Fetch it.
          const p = await getDoc(doc(db, "posts", postId));
          if(p.exists()) {
             openComments(postId, p.data().uid);
          }
      }
  };

  window.markReadOne = async (id) => updateDoc(doc(db, "notifications", id), { read: true });
  window.markAllRead = async () => {
      if(!currentUser) return;
      const q = query(collection(db, "notifications"), where("toUid", "==", currentUser.uid), where("read", "==", false));
      const snap = await getDocs(q);
      snap.forEach(d => updateDoc(doc(db, "notifications", d.id), { read: true }));
  };

  // --- MESSAGING SYSTEM ---
  function getChatId(uid1, uid2) { return [uid1, uid2].sort().join("_"); }

  window.startChat = async (targetUid, targetName, targetPhoto) => {
      if(!currentUser) return login();
      const chatId = getChatId(currentUser.uid, targetUid);
      
      // Check/Create Chat Metadata
      const chatRef = doc(db, "chats", chatId);
      await setDoc(chatRef, {
          participants: [currentUser.uid, targetUid],
          users: {
              [currentUser.uid]: { name: currentUser.displayName, photo: currentUser.photoURL },
              [targetUid]: { name: targetName, photo: targetPhoto }
          },
          lastUpdated: serverTimestamp()
      }, { merge: true });

      openChatWindow(chatId, targetName, targetPhoto);
  };

  window.loadInbox = () => {
      const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid), orderBy("lastUpdated", "desc"));
      onSnapshot(q, (snap) => {
          const list = document.getElementById('inbox-list');
          let html = "";
          if(snap.empty) { list.innerHTML = '<p style="text-align:center;margin-top:20px;color:#888">No messages yet.</p>'; return; }
          
          snap.forEach(d => {
              const data = d.data();
              // Find other user
              const otherUid = data.participants.find(u => u !== currentUser.uid);
              const otherUser = data.users[otherUid];
              
              html += `
              <div class="chat-list-item" onclick="openChatWindow('${d.id}', '${otherUser.name}', '${otherUser.photo}')">
                  <img src="${otherUser.photo}" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
                  <div>
                      <b style="font-size:16px;">${otherUser.name}</b><br>
                      <span style="color:#888; font-size:13px;">${data.lastMessage || 'Start conversation'}</span>
                  </div>
              </div>`;
          });
          list.innerHTML = html;
      });
  };

  window.openChatWindow = (chatId, name, photo) => {
      activeChatId = chatId;
      document.getElementById('view-conversation').style.display = 'block';
      document.getElementById('mainNav').style.display = 'none'; // Hide bottom nav
      document.getElementById('mainHeader').style.display = 'none'; // Hide top header
      
      document.getElementById('chat-header-name').innerText = name;
      document.getElementById('chat-header-avatar').src = photo;
      
      const q = query(collection(db, `chats/${chatId}/messages`), orderBy("timestamp", "asc"));
      onSnapshot(q, (snap) => {
          const area = document.getElementById('chat-messages');
          let html = "";
          snap.forEach(d => {
              const msg = d.data();
              const type = msg.senderId === currentUser.uid ? 'me' : 'them';
              html += `<div class="chat-bubble ${type}">${msg.text}</div>`;
          });
          area.innerHTML = html;
          area.scrollTop = area.scrollHeight;
      });
  };

  window.closeChat = () => {
      activeChatId = null;
      document.getElementById('view-conversation').style.display = 'none';
      document.getElementById('mainNav').style.display = 'flex';
      document.getElementById('mainHeader').style.display = 'flex';
  };

  window.sendMessage = async () => {
      const txt = document.getElementById('messageInput').value;
      if(!txt.trim() || !activeChatId) return;
      
      document.getElementById('messageInput').value = "";
      
      await addDoc(collection(db, `chats/${activeChatId}/messages`), {
          text: txt, senderId: currentUser.uid, timestamp: serverTimestamp()
      });
      await updateDoc(doc(db, "chats", activeChatId), {
          lastMessage: txt, lastUpdated: serverTimestamp()
      });
  };

  // --- PROFILE LOGIC ---
  window.viewUserProfile = (uid) => { loadProfile(uid); switchView('profile'); };

  async function loadProfile(targetUid) {
      const container = document.getElementById('profile-content');
      const userSnap = await getDoc(doc(db, "users", targetUid));
      if(!userSnap.exists()) return;
      const u = userSnap.data();
      
      let isFollowing = false;
      let followerCount = (await getDocs(collection(db, `users/${targetUid}/followers`))).size;
      
      if(currentUser) {
          const followSnap = await getDoc(doc(db, `users/${targetUid}/followers`, currentUser.uid));
          isFollowing = followSnap.exists();
      }

      const isMe = currentUser && currentUser.uid === targetUid;

      container.innerHTML = `
        <div class="profile-header">
            <img src="${u.photoURL}" class="profile-pic-lg">
            <h2>${u.displayName}</h2>
            <div class="stats">
                <div><b>${followerCount}</b><br><small>Followers</small></div>
            </div>
            <div style="display:flex; justify-content:center; margin-top:10px;">
                ${isMe ? 
                    `<button class="btn-follow" style="background:#ff4444;" onclick="doLogout()">Logout</button>` : 
                    `<button class="btn-follow ${isFollowing ? 'following' : ''}" onclick="toggleFollow('${targetUid}', ${isFollowing})">
                        ${isFollowing ? 'Following' : 'Follow'}
                    </button>
                    <button class="btn-msg" onclick="startChat('${targetUid}', '${u.displayName}', '${u.photoURL}')">Message</button>`
                }
            </div>
        </div>
      `;
  }

  window.toggleFollow = async (targetUid, isFollowing) => {
      if(!currentUser) return login();
      const ref = doc(db, `users/${targetUid}/followers`, currentUser.uid);
      if(isFollowing) {
          await deleteDoc(ref);
      } else {
          await setDoc(ref, { timestamp: serverTimestamp() });
          sendNotif(targetUid, 'follow', null, null);
      }
      loadProfile(targetUid);
  };
</script>
</body>
</html>
